<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break 2 System | V7.0</title>
    <!-- Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø§Ù„Ø®Ø· Ø¨Ø®Ø· Cairo Ù„Ø£ÙƒØ«Ø± ÙˆØ¶ÙˆØ­Ø§Ù‹ -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Ø£Ù„ÙˆØ§Ù† Ù…ÙˆØ¯Ø±Ù† ÙˆØ§Ø¶Ø­Ø© */
            --primary: #4f46e5;       /* Ø£Ø²Ø±Ù‚ Ù†ÙŠÙ„ÙŠ */
            --primary-dark: #4338ca;
            --secondary: #64748b;
            --bg-body: #f1f5f9;
            --surface: #ffffff;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            background-color: var(--bg-body);
            color: #1e293b;
            line-height: 1.6;
        }

        /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© Ù‡Ø§Ø¯ÙŠØ© */
        .bg-pattern {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(circle at 50% 120%, #e0e7ff, var(--bg-body));
        }

        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-page {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            background: var(--surface);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            border-radius: 24px;
            box-shadow: var(--shadow-lg);
            text-align: center;
            border: 1px solid #e2e8f0;
        }
        .login-icon { font-size: 60px; margin-bottom: 10px; display: inline-block; animation: float 3s ease-in-out infinite; }
        
        /* --- Ø§Ù„ØªØµÙ…ÙŠÙ… Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠ --- */
        .nav-bar {
            background: var(--surface);
            padding: 15px 25px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }
        .user-info { display: flex; align-items: center; gap: 10px; font-weight: 700; color: var(--primary); }
        .role-badge { background: #e0e7ff; color: var(--primary); padding: 4px 12px; border-radius: 20px; font-size: 0.85rem; }

        .nav-actions { display: flex; gap: 10px; }
        .nav-btn {
            background: transparent; border: none; padding: 8px 16px;
            font-family: 'Cairo'; font-weight: 600; color: var(--secondary);
            cursor: pointer; border-radius: 10px; transition: 0.3s;
        }
        .nav-btn:hover { background: #f8fafc; color: var(--primary); }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.3); }

        /* Grid Layout */
        .main-grid { display: grid; grid-template-columns: 350px 1fr; gap: 25px; }
        @media (max-width: 900px) { .main-grid { grid-template-columns: 1fr; } }

        /* Cards & Inputs */
        .card {
            background: var(--surface);
            padding: 25px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            border: 1px solid #e2e8f0;
            margin-bottom: 20px;
        }
        h3 { margin-top: 0; color: #0f172a; font-size: 1.2rem; display: flex; align-items: center; gap: 8px; }
        
        label { display: block; margin-bottom: 6px; font-size: 0.9rem; font-weight: 600; color: #475569; }
        input, select, textarea {
            width: 100%; padding: 12px 15px; border: 2px solid #e2e8f0;
            border-radius: 12px; font-family: 'Cairo'; font-size: 1rem; transition: 0.3s;
            background: #f8fafc;
        }
        input:focus, select:focus, textarea:focus { border-color: var(--primary); background: white; box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1); }
        textarea { resize: vertical; min-height: 100px; }

        .btn-main {
            width: 100%; background: var(--primary); color: white;
            padding: 14px; border: none; border-radius: 12px;
            font-size: 1rem; font-weight: 700; cursor: pointer;
            margin-top: 10px; transition: 0.3s; box-shadow: 0 4px 6px rgba(79, 70, 229, 0.2);
        }
        .btn-main:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-danger { background: #fee2e2; color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        /* Complaint Cards (Feed) */
        .feed-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid #e2e8f0;
            border-right: 5px solid var(--warning);
            transition: transform 0.2s;
            position: relative;
            box-shadow: var(--shadow);
        }
        .feed-card:hover { transform: translateY(-3px); }
        .feed-card.done { border-right-color: var(--success); opacity: 0.9; }
        .feed-card.price { border-right-color: var(--primary); background: #f5f3ff; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px; }
        .branch-title { font-size: 1.1rem; font-weight: 700; color: #1e293b; display: flex; align-items: center; gap: 5px; }
        .meta-tag { background: #f1f5f9; padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; font-weight: 600; color: #64748b; }
        
        .card-body { background: #f8fafc; padding: 12px; border-radius: 10px; margin: 10px 0; color: #334155; font-weight: 600; }
        
        /* Reply Section */
        .action-area { margin-top: 15px; padding-top: 15px; border-top: 1px dashed #cbd5e1; }
        .btn-row { display: flex; gap: 8px; margin-bottom: 8px; }
        .btn-s { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-family: 'Cairo'; font-size: 0.9rem; color: white; transition: 0.2s; }
        .btn-ok { background: var(--success); }
        .btn-ok:hover { filter: brightness(0.9); }
        .btn-info { background: #3b82f6; }
        .btn-send-note { background: #64748b; flex: none; width: auto; padding: 0 20px; }

        /* Tables */
        .table-container { overflow-x: auto; background: white; border-radius: 16px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; padding: 15px; text-align: right; color: #475569; font-weight: 700; border-bottom: 2px solid #e2e8f0; }
        td { padding: 15px; border-bottom: 1px solid #f1f5f9; color: #334155; font-weight: 600; }
        tr:hover { background: #f8fafc; }
        .status-badge { display: inline-block; padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; }
        .status-badge.done { background: #d1fae5; color: #065f46; }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
    </style>
</head>
<body>

    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>
    <div class="bg-pattern"></div>

    <div class="container">
        
        <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="login-page">
            <div class="login-card fade-in">
                <div class="login-icon">ğŸ›¡ï¸</div>
                <h2 style="color:var(--primary); margin-bottom:5px;">Break 2 System</h2>
                <p style="color:#64748b; margin-bottom:30px;">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ÙØ±ÙˆØ¹ ÙˆØ§Ù„Ø´ÙƒØ§ÙˆÙ‰ V7.0</p>
                
                <div style="text-align: right;">
                    <label>Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="Ù…Ø«Ø§Ù„: admin">
                    
                    <label style="margin-top:15px;">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <button class="btn-main" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
            </div>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div id="system-content" class="hidden fade-in">
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
            <nav class="nav-bar">
                <div class="user-info">
                    <span class="role-badge" id="roleLabel">--</span>
                    <span id="userInfo" style="font-size:1.1rem;">--</span>
                </div>
                <div class="nav-actions">
                    <button id="btnMain" class="nav-btn active" onclick="showPage('main')">ğŸ“‹ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</button>
                    <button id="btnArchive" class="nav-btn" onclick="showPage('archive')">ğŸ“‚ Ø§Ù„Ø³Ø¬Ù„</button>
                    <button class="nav-btn btn-danger" onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</button>
                </div>
            </nav>

            <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div id="page-main">
                <div class="main-grid">
                    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Ø£ÙƒØ´Ù†) -->
                    <aside id="sideAction"></aside>

                    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¨Ù„Ø§ØºØ§Øª -->
                    <main>
                        <h3 style="margin-bottom:15px;">ğŸ“¡ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø­Ø¸ÙŠØ© (Live Feed)</h3>
                        <div id="priceSection"></div>
                        <div id="activeList"></div>
                    </main>
                </div>
            </div>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
            <div id="page-archive" class="hidden">
                <div class="card">
                    <h3>ğŸ” ÙÙ„ØªØ± Ø§Ù„Ø¨Ø­Ø«</h3>
                    <div class="main-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                        <div><label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label><input type="text" id="fOrder" oninput="filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±..."></div>
                        <div id="branchFilterBox"><label>Ø§Ù„ÙØ±Ø¹</label>
                            <select id="fBranch" onchange="filterHistory()">
                                <option value="">Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„</option>
                                <option>Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§</option>
                                <option>Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡</option>
                                <option>ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³</option>
                                <option>Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯</option>
                                <option>Ø§Ù„Ù…Ø¹Ù‡Ø¯</option>
                                <option>Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡</option>
                            </select>
                        </div>
                        <div><label>Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±</label><input type="text" id="fDriver" oninput="filterHistory()" placeholder="Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±..."></div>
                    </div>
                </div>

                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ØªÙˆÙ‚ÙŠØª</th>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>Ø£ÙˆØ±Ø¯Ø± #</th>
                                <th>Ø§Ù„Ø·ÙŠØ§Ø±</th>
                                <th>Ø§Ù„Ø±Ø¯ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ</th>
                                <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                                <th>ØªØ­ÙƒÙ…</th>
                            </tr>
                        </thead>
                        <tbody id="archiveTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // -----------------------------------------
        // âœ… 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (ØªÙ…Øª Ø¥Ø¶Ø§ÙØªÙ‡Ø§ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹)
        // -----------------------------------------
        const WA_GATEWAY = {
            instance_id: 'instance157671', 
            token: 'cpx85mx613v868fe'      
        };

        // -----------------------------------------
        // ğŸ›‘ 2. Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù…Ø¯ÙŠØ±ÙŠÙ† (Ø¹Ø¯Ù„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯ÙŠ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
        // -----------------------------------------
        const branchManagers = {
            "Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§": "01271301772", 
            "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡": "201022222222",
            "ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³": "201033333333",
            "Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯": "201044444444",
            "Ø§Ù„Ù…Ø¹Ù‡Ø¯": "201055555555",
            "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡": "201066666666"
        };

        // -----------------------------------------
        // 3. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
        // -----------------------------------------
        const firebaseConfig = {
            apiKey: "AIzaSyBSwsheoAEJm3pLMI8lhVvzFnLS-a4FrVA",
            authDomain: "break2-5de32.firebaseapp.com",
            databaseURL: "https://break2-5de32-default-rtdb.firebaseio.com",
            projectId: "break2-5de32",
            storageBucket: "break2-5de32.firebasestorage.app",
            messagingSenderId: "864134684796",
            appId: "1:864134684796:web:078af20f713c95a08be9f9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // -----------------------------------------
        // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†
        // -----------------------------------------
        const users = {
            "admin": { pass: "123", role: "admin", name: "Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø§Ù…Ø©" },
            "ahmed": { pass: "123", role: "callcenter", name: "Ø£Ø­Ù…Ø¯ Ø­Ù…Ø¯ÙŠ" },
            "mahmoud": { pass: "2002", role: "callcenter", name: "Ù…Ø­Ù…ÙˆØ¯ Ù‡Ø§Ù†ÙŠ" },
            "branch1": { pass: "pass1", role: "branch", name: "Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§" },
            "branch2": { pass: "pass2", role: "branch", name: "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡" },
            "branch3": { pass: "pass3", role: "branch", name: "ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³" },
            "branch4": { pass: "pass4", role: "branch", name: "Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯" },
            "branch5": { pass: "pass5", role: "branch", name: "Ø§Ù„Ù…Ø¹Ù‡Ø¯" },
            "branch6": { pass: "pass6", role: "branch", name: "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡" }
        };

        let currentUser = null;
        let allData = [];

        // --- WhatsApp Logic ---
        async function sendWhatsAppToManager(branchName, orderNum, driver, msg) {
            const targetPhone = branchManagers[branchName];
            if (!targetPhone) return console.log("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù„Ù…Ø¯ÙŠØ±");

            const messageBody = 
`ğŸš¨ *Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ | Break 2 System*
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ¢ *Ø§Ù„ÙØ±Ø¹:* ${branchName}
ğŸ“ *Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:* ${orderNum}
ğŸ›µ *Ø§Ù„Ø·ÙŠØ§Ø±:* ${driver}
âš ï¸ *Ø§Ù„Ø´ÙƒÙˆÙ‰:* ${msg}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
*Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø© ÙˆØ§Ù„Ø±Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ³ØªÙ….*`;

            const url = `https://api.ultramsg.com/${WA_GATEWAY.instance_id}/messages/chat`;
            const payload = { token: WA_GATEWAY.token, to: targetPhone, body: messageBody };

            try {
                await fetch(url, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
                console.log("âœ… Whatsapp Sent");
            } catch (error) { console.error("âŒ Whatsapp Error", error); }
        }

        // --- System Logic ---
        function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if (users[u] && users[u].pass === p) {
                localStorage.setItem('break2_user', JSON.stringify({ id: u, ...users[u] }));
                location.reload();
            } else alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø© âŒ");
        }

        function logout() { localStorage.removeItem('break2_user'); location.reload(); }

        window.onload = () => {
            const saved = localStorage.getItem('break2_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('system-content').classList.remove('hidden');
                document.getElementById('userInfo').innerText = currentUser.name;
                document.getElementById('roleLabel').innerText = (currentUser.role === 'admin' ? 'Ù…Ø¯ÙŠØ± Ø¹Ø§Ù…' : (currentUser.role === 'callcenter' ? 'ÙƒÙˆÙ„ Ø³Ù†ØªØ±' : 'ÙØ±Ø¹'));
                setupSideBar();
                listenToData();
            }
        };

        function setupSideBar() {
            const side = document.getElementById('sideAction');
            if (currentUser.role === 'admin' || currentUser.role === 'callcenter') {
                side.innerHTML = `
                    <div class="card">
                        <h3 style="color:var(--primary);">â• Ø¥Ø±Ø³Ø§Ù„ Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯</h3>
                        <label>Ø§Ø®ØªØ± Ø§Ù„ÙØ±Ø¹</label>
                        <select id="admBranch">
                            <option value="" disabled selected>-- Ø§Ø®ØªØ± --</option>
                            <option>Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§</option>
                            <option>Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡</option>
                            <option>ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³</option>
                            <option>Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯</option>
                            <option>Ø§Ù„Ù…Ø¹Ù‡Ø¯</option>
                            <option>Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡</option>
                        </select>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± #</label>
                        <input type="text" id="admOrder" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ù‚Ù…...">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±</label>
                        <input type="text" id="admDriver" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù…...">
                        <label>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                        <textarea id="admComplaint" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„ØªÙØ§ØµÙŠÙ„ Ù‡Ù†Ø§..."></textarea>
                        <button class="btn-main" onclick="sendComplaint()">ğŸš€ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº</button>
                    </div>`;
            } else {
                document.getElementById('branchFilterBox').classList.add('hidden');
                side.innerHTML = `
                    <div class="card">
                        <h3 style="color:var(--primary);">ğŸ’° Ø·Ù„Ø¨ Ø³Ø¹Ø± ØªÙˆØµÙŠÙ„</h3>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø± #</label>
                        <input type="text" id="brOrder" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±">
                        <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­ (Ø¬Ù†ÙŠØ©)</label>
                        <input type="number" id="brPrice" placeholder="Ø§Ù„Ø³Ø¹Ø±">
                        <button class="btn-main" onclick="sendPriceReq()">ğŸ“© Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨</button>
                    </div>`;
            }
        }

        function showPage(pageId) {
            document.getElementById('page-main').classList.add('hidden');
            document.getElementById('page-archive').classList.add('hidden');
            document.getElementById('btnMain').classList.remove('active');
            document.getElementById('btnArchive').classList.remove('active');
            document.getElementById('page-' + pageId).classList.remove('hidden');
            document.getElementById('btn' + pageId.charAt(0).toUpperCase() + pageId.slice(1)).classList.add('active');
        }

        function listenToData() {
            db.ref('system_v6').on('value', snap => {
                allData = [];
                snap.forEach(child => {
                    const item = child.val();
                    item.id = child.key;
                    // Ø­Ø°Ù Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© (Ø£ÙƒØ«Ø± Ù…Ù† 20 Ø¯Ù‚ÙŠÙ‚Ø©)
                    if (item.type === 'price_request' && (Date.now() - item.timestamp > 20 * 60 * 1000)) {
                        db.ref('system_v6/' + item.id).remove(); return;
                    }
                    allData.push(item);
                });
                renderUI();
            });
        }

        function renderUI() {
            const priceDiv = document.getElementById('priceSection');
            const activeDiv = document.getElementById('activeList');
            priceDiv.innerHTML = ""; activeDiv.innerHTML = "";

            allData.forEach(item => {
                if (currentUser.role === 'branch' && item.branch !== currentUser.name) return;

                if (item.type === 'price_request') {
                    if (currentUser.role === 'branch' && item.status === 'done') return;
                    if (item.status === 'pending') {
                        priceDiv.innerHTML += `
                            <div class="feed-card price">
                                <div class="card-header">
                                    <div class="branch-title">ğŸ’° Ø·Ù„Ø¨ ØªØ³Ø¹ÙŠØ±: ${item.branch}</div>
                                    <span class="meta-tag">#${item.orderNum}</span>
                                </div>
                                <div style="display:flex; gap:10px; align-items:center;">
                                    <span style="font-weight:bold; font-size:1.1rem; color:var(--primary);">Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­: ${item.suggestedPrice} Ø¬</span>
                                    ${(currentUser.role === 'admin' || currentUser.role === 'callcenter') ? `
                                        <div style="display:flex; gap:5px; margin-right:auto;">
                                            <input type="number" id="admP-${item.id}" value="${item.suggestedPrice}" style="width:70px; padding:5px; height:35px; margin:0;">
                                            <button class="btn-s btn-ok" onclick="approvePrice('${item.id}')">Ø§Ø¹ØªÙ…Ø§Ø¯ âœ…</button>
                                        </div>
                                    ` : `<small style="margin-right:auto;">â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</small>`}
                                </div>
                            </div>`;
                    }
                } else if (item.type === 'complaint' && item.status === 'pending') {
                    activeDiv.innerHTML += `
                        <div class="feed-card fade-in">
                            <div class="card-header">
                                <div class="branch-title">ğŸ“ ${item.branch}</div>
                                <span class="meta-tag">ğŸ‘¤ ${item.senderName || 'Ø§Ù„Ù†Ø¸Ø§Ù…'}</span>
                            </div>
                            <div style="font-size:0.9rem; color:#64748b; margin-bottom:5px;">
                                ğŸ›µ Ø·ÙŠØ§Ø±: <b>${item.driver}</b> | ğŸ”¢ Ø£ÙˆØ±Ø¯Ø±: <b>#${item.orderNum}</b>
                            </div>
                            <div class="card-body">
                                "${item.msg}"
                            </div>
                            ${currentUser.role === 'branch' ? `
                                <div class="action-area">
                                    <div class="btn-row">
                                        <button class="btn-s btn-ok" onclick="replyComp('${item.id}', 'ØªÙ… Ø§Ù„Ø­Ù„ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ âœ…')">ÙƒØ§Ù…Ù„ âœ…</button>
                                        <button class="btn-s btn-info" onclick="replyComp('${item.id}', 'ØªÙ… Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£ÙˆØ±Ø¯Ø± ğŸ‘')">ØªÙ…Ø§Ù… ğŸ‘</button>
                                    </div>
                                    <div style="display:flex; gap:5px;">
                                        <input type="text" id="reason-${item.id}" placeholder="Ø§ÙƒØªØ¨ Ø±Ø¯ Ù…Ø®ØµØµ..." style="margin:0;">
                                        <button class="btn-s btn-send-note" onclick="sendReason('${item.id}')">Ø±Ø¯</button>
                                    </div>
                                </div>
                            ` : `<div style="text-align:center; padding:5px; background:#f1f5f9; border-radius:8px; font-size:0.85rem;">â³ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø±Ø¯ Ø§Ù„ÙØ±Ø¹...</div>`}
                        </div>`;
                }
            });
            filterHistory();
        }

        function filterHistory() {
            const body = document.getElementById('archiveTableBody');
            const fOrder = document.getElementById('fOrder').value.toLowerCase();
            const fBranch = currentUser.role === 'branch' ? currentUser.name : document.getElementById('fBranch').value;
            const fDriver = document.getElementById('fDriver').value.toLowerCase();

            body.innerHTML = "";
            const history = allData.filter(item => {
                if (item.type !== 'complaint' || item.status !== 'done') return false;
                if (fOrder && !item.orderNum.toString().includes(fOrder)) return false;
                if (fBranch && item.branch !== fBranch) return false;
                if (fDriver && !item.driver.toLowerCase().includes(fDriver)) return false;
                return true;
            });

            if(history.length === 0) {
                body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø³Ø¬Ù„Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ù„Ø¨Ø­Ø«</td></tr>`;
                return;
            }

            history.reverse().forEach(item => {
                body.innerHTML += `<tr>
                    <td style="font-size:0.85rem; color:#64748b;">${item.time || '-'}</td>
                    <td><span style="font-weight:700;">${item.branch}</span></td>
                    <td>#${item.orderNum}</td>
                    <td>${item.driver || '-'}</td>
                    <td><span class="status-badge done">${item.reply || 'ØªÙ…'}</span></td>
                    <td><small>${item.senderName || 'System'}</small></td>
                    <td>${currentUser.role === 'admin' ? `<button onclick="deleteItem('${item.id}')" style="color:var(--danger); background:none; border:none; cursor:pointer; font-weight:bold;">Ø­Ø°Ù ğŸ—‘ï¸</button>` : '-'}</td>
                </tr>`;
            });
        }

        // --- Actions ---
        function sendComplaint() {
            const b = document.getElementById('admBranch').value;
            const o = document.getElementById('admOrder').value;
            const d = document.getElementById('admDriver').value;
            const m = document.getElementById('admComplaint').value;
            if(!b || !o || !m) return alert("âŒ ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©");
            
            db.ref('system_v6').push({
                type: 'complaint', branch: b, orderNum: o, driver: d, msg: m, status: 'pending', 
                senderName: currentUser.name, time: new Date().toLocaleString('ar-EG')
            });

            sendWhatsAppToManager(b, o, d, m);

            document.getElementById('admOrder').value = ""; 
            document.getElementById('admDriver').value = "";
            document.getElementById('admComplaint').value = "";
            alert("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ù†Ø¬Ø§Ø­");
        }

        function sendPriceReq() {
            const o = document.getElementById('brOrder').value;
            const p = document.getElementById('brPrice').value;
            if(!o || !p) return alert("âŒ Ø§ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
            db.ref('system_v6').push({
                type: 'price_request', branch: currentUser.name, orderNum: o, suggestedPrice: p, 
                status: 'pending', timestamp: Date.now(), time: new Date().toLocaleString('ar-EG')
            });
            document.getElementById('brOrder').value = ""; document.getElementById('brPrice').value = "";
        }

        function approvePrice(id) {
            const p = document.getElementById('admP-' + id).value;
            db.ref('system_v6/' + id).update({ status: 'done', reply: "Ø³Ø¹Ø± Ø§Ù„ØªÙˆØµÙŠÙ„: " + p + " Ø¬", approverName: currentUser.name });
        }

        function replyComp(id, msg) { 
            db.ref('system_v6/' + id).update({ status: 'done', reply: msg }); 
        }

        function sendReason(id) {
            const val = document.getElementById('reason-' + id).value.trim();
            if(!val) return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø±Ø¯ Ø£ÙˆÙ„Ø§Ù‹");
            replyComp(id, val);
        }

        function deleteItem(id) { if(confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ")) db.ref('system_v6/' + id).remove(); }
    </script>
</body>
</html>
