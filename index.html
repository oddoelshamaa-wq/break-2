<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ·ÙˆØ± - Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f1c40f;
            --meeting-color: #f39c12;
            --prayer-color: #2980b9;
            --emergency-color: #c0392b;
            --followup-color: #16a085;
            --dark-text: #2d3436;
            --vip-color: #f39c12;
        }

        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; padding: 20px 10px; min-height: 100vh; color: var(--dark-text); }
        
        @keyframes flash-red { 0% { background-color: #ffcccc; } 50% { background-color: #ff0000; box-shadow: 0 0 20px red; } 100% { background-color: #ffcccc; } }
        .ÙˆØ¶Ø¹-Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ { animation: flash-red 0.8s infinite; }
        .ØµÙ-ØªØ­Ø°ÙŠØ± { background-color: #fff9c4 !important; }

        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; margin-bottom: 20px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-family: 'Cairo', sans-serif; color: white; transition: all 0.3s ease; margin: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #2980b9; } .btn-danger { background: #c0392b; } .btn-success { background: #27ae60; } .btn-warning { background: #f39c12; } .btn-info { background: #8e44ad; } .btn-dark { background: #2d3436; } .btn-purple { background: #8e44ad; } .btn-followup { background: var(--followup-color); } .btn-vip { background: linear-gradient(45deg, #d4af37, #f1c40f); border: 1px solid #b8860b; color: #000; }
        
        input, select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: 'Cairo', sans-serif; font-size: 0.95rem; }
        input:focus { outline: none; border-color: var(--primary-color); background: #fff; }

        .table-responsive { width: 100%; overflow-x: auto; margin-top: 15px; border-radius: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; min-width: 850px; }
        th { background: #2c3e50; color: white; padding: 12px 8px; font-size: 0.85rem; }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; vertical-align: middle; }

        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .hidden { display: none !important; }
        
        .timer-display { font-size: 3rem; font-weight: 800; color: var(--primary-color); margin: 10px 0; }
        .timer-label { font-size: 1.1rem; color: #777; font-weight: 700; }
        
        .summary-card { background: white; border: 2px solid #2ecc71; padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .summary-item { text-align: center; min-width: 120px; }
        .summary-item p { margin: 2px 0 0; font-size: 1.1rem; font-weight: bold; color: #27ae60; }
        
        .online-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .dot-green { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .dot-grey { background-color: #95a5a6; }
        
        .admin-table-ctrl { display: flex; flex-direction: column; gap: 5px; max-width: 220px; margin: auto; padding: 5px; background: #fdfdfd; border-radius: 8px; border: 1px solid #eee; }
        .admin-row-top { display: flex; gap: 4px; }
        .admin-row-top select { margin: 0; height: 38px; flex: 1.5; font-size: 0.8rem; border: 2px solid #ddd; }
        .activity-text { font-size: 0.75rem; color: #555; text-align: right; line-height: 1.5; display: block; padding: 2px 0; border-bottom: 1px dashed #eee; }
        .badge-count { background: red; color: white; padding: 2px 6px; border-radius: 50%; font-size: 0.7rem; position: absolute; margin-top: -10px; margin-right: 5px; }

        .filter-box { background: #f8f9fa; padding: 15px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; }
        .search-input { border: 2px solid #2980b9 !important; background: #fff url('https://cdn-icons-png.flaticon.com/512/149/149852.png') no-repeat 10px center; background-size: 20px; padding-right: 40px; }
        
        .limit-box { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: flex; flex-direction: column; gap: 10px; }
        .limit-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 10px; width: 100%; }
        .limit-input-group { background: white; border: 1px solid #ddd; padding: 8px 15px; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        
        .vip-badge { background: #ffd700; color: #000; padding: 2px 8px; border-radius: 5px; font-weight: bold; font-size: 0.75rem; box-shadow: 0 0 5px #ffd700; }
        .del-btn-report { background: #ff7675; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 2px 5px; font-size: 0.7rem; margin-right: 5px; }

        .server-clock-box {
            background: #2c3e50; color: #fff; padding: 8px 20px; border-radius: 12px; font-size: 0.9rem; display: inline-flex; flex-direction: column; align-items: center; border: 2px solid #34495e; box-shadow: 0 4px 15px rgba(0,0,0,0.15); margin-bottom: 10px; min-width: 180px;
        }
        .clock-time { font-size: 1.1rem; font-weight: 800; color: #2ecc71; font-family: 'Cairo', sans-serif; }
        .clock-date { font-size: 0.75rem; color: #bdc3c7; font-weight: bold; }
        .server-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; color: #e74c3c; }

        #broadcastOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 10000; display: none; flex-direction: column; align-items: center; justify-content: center; color: white; text-align: center; padding: 20px; }
        .broadcast-content { background: white; color: #2c3e50; padding: 40px; border-radius: 30px; max-width: 600px; width: 90%; box-shadow: 0 0 50px rgba(231, 76, 60, 1); border: 8px solid #e74c3c; animation: pulse-emergency 1s infinite; }
        @keyframes pulse-emergency { 0% { transform: scale(1); box-shadow: 0 0 20px #e74c3c; } 50% { transform: scale(1.05); box-shadow: 0 0 60px #e74c3c; } 100% { transform: scale(1); box-shadow: 0 0 20px #e74c3c; } }

        #bottomToast { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #e74c3c; color: white; padding: 15px 30px; border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3); z-index: 99999; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55); display: flex; align-items: center; gap: 10px; min-width: 300px; justify-content: center; }
        #bottomToast.show { bottom: 30px; }

        .notification-log { margin-top: 20px; background: #fff; border-radius: 15px; border: 1px solid #eee; overflow: hidden; text-align: right; }
        .log-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; display: flex; justify-content: space-between; }
        .log-body { max-height: 200px; overflow-y: auto; padding: 10px; }
        .log-item { padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
        .log-time { color: #999; font-size: 0.7rem; }

        .dept-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 5px; color: white; font-weight: bold; display: inline-block; margin-right: 5px; }
        .bg-talabat { background: #e67e22; }
        .bg-whatsapp { background: #27ae60; }
        .bg-recievers { background: #8e44ad; }
        .bg-other { background: #7f8c8d; }
    </style>
</head>
<body>

<div id="loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="border:5px solid #f3f3f3; border-top:5px solid #2c3e50; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;"></div>
    <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù†Ø¸Ø§Ù… Ø§Ù„Ø£Ù‚Ø³Ø§Ù…...</h3>
</div>

<audio id="alarmSound" loop preload="auto"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg"></audio>
<audio id="notifySound" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" type="audio/mp3"></audio>
<audio id="requestRing" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3" type="audio/mp3"></audio>
<audio id="broadcastSound" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" type="audio/mp3"></audio>

<div id="broadcastOverlay">
    <div class="broadcast-content">
        <div style="font-size: 5rem; margin-bottom: 10px;">ğŸš¨</div>
        <h1 style="color: #c0392b; margin-top: 0; font-size: 2.5rem;">ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ Ø¹Ø§Ø¬Ù„</h1>
        <p id="broadcastMsgText" style="font-size: 1.8rem; font-weight: bold; margin: 25px 0; line-height: 1.6; color: #2d3436;"></p>
        <button onclick="acknowledgeBroadcast()" class="btn btn-danger" style="width: 100%; padding: 20px; font-size: 1.5rem; border-radius: 15px;">Ø§Ø³ØªÙ„Ù…Øª Ø§Ù„Ø±Ø³Ø§Ù„Ø© âœ…</button>
    </div>
</div>

<div id="bottomToast">
    <span>ğŸ“¢</span>
    <span id="toastText">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
</div>

<div class="container hidden" id="mainContainer">
    
    <div id="loginSection">
        <h2>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…</h2>
        <div style="max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding: 15px;">Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</button>
        </div>
    </div>

    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 10px;">
            <div>
                <h2 style="margin:0; font-size:1.3rem;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù… ğŸš€</h2>
                <span id="currentManagerDisplay" style="font-size: 0.8rem; font-weight: bold; display:block; margin-top:5px;"></span>
                <button onclick="enableSound()" class="btn btn-sm btn-info" id="soundBtn" style="margin-top:10px;">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
            </div>
            <div class="server-clock-box">
                <span class="server-label">Ø§Ù„ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø±Ø³Ù…ÙŠ</span>
                <span class="clock-time" id="adminServerTime">00:00:00 AM</span>
                <span class="clock-date" id="adminServerDate">--/--/----</span>
            </div>
            <button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary btn-sm">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            <button onclick="switchAdminTab('emergency')" class="btn btn-danger btn-sm">ğŸš¨ Ø§Ù„Ø·ÙˆØ§Ø±Ø¦ <span id="emBadge" class="badge-count hidden">0</span></button>
            <button onclick="switchAdminTab('overtime')" class="btn btn-purple btn-sm">ğŸ•’ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ <span id="otBadge" class="badge-count hidden">0</span></button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning btn-sm">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success btn-sm">âš™ï¸ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <div id="tab-monitor">
            <div class="limit-box">
                <h4 style="margin:0 0 10px 0; color:#2c3e50;">âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù„ÙƒÙ„ Ù‚Ø³Ù…:</h4>
                <div class="limit-grid">
                    <div class="limit-input-group">
                        <strong>ğŸ“¦ Ø·Ù„Ø¨Ø§Øª:</strong>
                        <input type="number" id="limit_talabat" style="width:60px; margin:0;" min="0" value="2">
                    </div>
                    <div class="limit-input-group">
                        <strong>ğŸ’¬ ÙˆØ§ØªØ³Ø§Ø¨:</strong>
                        <input type="number" id="limit_whatsapp" style="width:60px; margin:0;" min="0" value="2">
                    </div>
                    <div class="limit-input-group">
                        <strong>ğŸ§ Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª:</strong>
                        <input type="number" id="limit_recievers" style="width:60px; margin:0;" min="0" value="2">
                    </div>
                    <div class="limit-input-group">
                        <strong>ğŸ•Œ Ø§Ù„ØµÙ„Ø§Ø© (Ø¹Ø§Ù…):</strong>
                        <input type="number" id="maxPrayersInput" style="width:60px; margin:0;" min="1" value="3">
                    </div>
                </div>
                <button onclick="updateLimits()" class="btn btn-dark btn-sm" style="width:100%; margin-top:10px;">Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</button>
            </div>

            <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                <input type="text" id="monitorSearch" placeholder="Ø¨Ø­Ø« Ø¹Ù† Ù…ÙˆØ¸Ù Ø¨Ø§Ù„Ø§Ø³Ù…..." class="search-input" oninput="renderMonitorTable()">
                <button onclick="endDay()" class="btn btn-danger btn-sm" style="flex-shrink: 0;">ğŸ›‘ Ø¥Ù‚ÙØ§Ù„ Ø§Ù„ÙŠÙˆÙ…</button>
            </div>
            
            <div id="statusCountersDisplay" style="text-align:right; font-weight:bold; margin-bottom:15px; font-size:0.9rem; color:#2c3e50; background: #f1f2f6; padding: 10px; border-radius: 10px; line-height: 1.8;">
                Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
            </div>
            
            <div class="table-responsive">
                <table id="monitorTable">
                    <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>ØµÙ„Ø§Ø© / Ù…ØªØ¨Ø¹</th><th>ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù</th></tr></thead>
                    <tbody id="monitorBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„Ø£Ø®Ø±Ù‰ ØªØ¨Ù‚ÙŠ ÙƒÙ…Ø§ Ù‡ÙŠ -->
        <div id="tab-emergency" class="hidden">
            <h3>ğŸš¨ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø®Ø±ÙˆØ¬ Ø§Ø¶Ø·Ø±Ø§Ø±ÙŠ</h3>
            <div class="table-responsive"><table><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø¨Ø¨</th><th>Ø§Ù„ÙˆÙ‚Øª</th><th>Ø§Ù„Ù‚Ø±Ø§Ø±</th></tr></thead><tbody id="adminEmBody"></tbody></table></div>
        </div>
        <div id="tab-overtime" class="hidden">
            <h3>ğŸ•’ Ø·Ù„Ø¨Ø§Øª Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ</h3>
            <div class="table-responsive"><table><thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th><th>ÙˆÙ‚Øª Ø§Ù„Ø·Ù„Ø¨</th><th>Ø§Ù„Ù‚Ø±Ø§Ø±</th></tr></thead><tbody id="adminOtBody"></tbody></table></div>
        </div>
        <div id="tab-reports" class="hidden">
            <div class="filter-box">
                <select id="reportUserSelect"><option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option></select>
                <div style="display:flex; gap:10px; margin-top:10px;">
                   <input type="date" id="filterStartDate">
                   <input type="date" id="filterEndDate">
                </div>
                <button onclick="renderUserReport()" class="btn btn-primary" style="width:100%; margin-top: 10px;">ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
                <button id="masterDeleteBtn" onclick="deleteAllReports()" class="btn btn-danger hidden" style="width:100%; margin-top: 10px;">âš ï¸ Ø­Ø°Ù Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹</button>
            </div>
            <div class="summary-card hidden" id="monthlySummary">
                <div class="summary-item"><h5>Ø§Ù„Ø£ÙƒØ³Ø¯Ø©</h5><p id="monthTotalBreaks">0 Ø¯</p></div>
                <div class="summary-item"><h5>Ø§Ù„ØµÙ„Ø§Ø©</h5><p id="monthTotalPrayer">0 Ø¯</p></div>
                <div class="summary-item"><h5>Ø¥Ø¶Ø§ÙÙŠ</h5><p id="monthTotalOvertime">0 Ø³</p></div>
            </div>
            <div class="table-responsive"><table id="sessionsTable"><thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø³Ø¬Ù„</th><th>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ</th><th>Ø§Ù„Ø£ÙƒØ³Ø¯Ø©</th></tr></thead><tbody id="sessionsReportBody"></tbody></table></div>
        </div>

        <div id="tab-users" class="hidden">
            <div style="background:#f9f9f9; padding:20px; border-radius:15px; border: 1px dashed #ccc; margin-bottom: 20px;">
                <h4 style="margin-top:0;" id="formTitle">ğŸ“ Ø¥Ø¶Ø§ÙØ©/ØªØ¹Ø¯ÙŠÙ„ Ù…ÙˆØ¸Ù</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                    <input type="text" id="newUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„">
                    <input type="text" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <input type="number" id="newAllowance" placeholder="Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ø¨Ø±ÙŠÙƒ" value="45">
                    <select id="newDepartment">
                        <option value="Ø·Ù„Ø¨Ø§Øª">Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                        <option value="ÙˆØ§ØªØ³Ø§Ø¨">Ù‚Ø³Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
                        <option value="Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª">Ù‚Ø³Ù… Ù…ØªÙ„Ù‚ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                        <option value="Ø£Ø®Ø±Ù‰">Ø£Ù‚Ø³Ø§Ù… Ø£Ø®Ø±Ù‰ / Ø¥Ø´Ø±Ø§Ù</option>
                    </select>
                </div>
                <div style="margin: 10px 0; display: flex; flex-direction: column; gap: 5px;">
                    <label><input type="checkbox" id="isVIPUser"> â­ Ù…ÙˆØ¸Ù VIP</label>
                    <label><input type="checkbox" id="canFollowUp"> ğŸ“ Ù…ÙŠØ²Ø© Ù…ØªØ§Ø¨Ø¹ Ø¹Ù…ÙŠÙ„</label>
                </div>
                <button onclick="saveUser()" id="saveUserBtn" class="btn btn-success" style="width:100%">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
                <button onclick="resetUserForm()" class="btn btn-dark" style="width:100%; margin-top:5px;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
            <div class="table-responsive">
                <table><thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Username</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ù…Ø¯Ø©</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody id="usersManagementBody"></tbody></table>
            </div>
        </div>
    </div>

    <div id="employeeSection" class="hidden">
        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
            <div>
                <h4 id="welcomeMsg" style="margin:0;"></h4>
                <p id="myDeptDisplay" style="margin:0; font-size:0.8rem; font-weight:bold; color:#7f8c8d;"></p>
                <button onclick="requestNotificationPermission()" id="notifBtn" class="btn btn-warning btn-sm">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
            </div>
            <button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <div style="text-align: center;">
            <div style="background: #f1f2f6; padding: 20px; border-radius: 20px; margin: 15px 0;">
                <div id="timerLabel" class="timer-label">Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                <div class="timer-display" id="userTimer">00:00</div>
                <h3 id="userStatusMsg"></h3>
                <div id="overtimeAlert" class="hidden" style="color:white; background:red; padding:10px; border-radius:10px;">Ø£Ù†Øª ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙƒØ³Ø¯Ø©!</div>
            </div>

            <div id="breakLimitAlert" style="background:#fff3cd; padding:15px; border-radius:10px; margin-bottom:15px; display:none; color:#856404; border:1px solid #ffeeba;"></div>

            <div id="controlsArea">
                <input type="text" id="breakReason" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="text-align: center;">
                <div id="vipControlArea" class="hidden"><button onclick="startMyBreak('Ø§Ø³ØªØ±Ø§Ø­Ø© VIP')" class="btn btn-vip" style="width:100%; padding:15px;">ğŸ‘‘ Ø¨Ø±ÙŠÙƒ VIP</button></div>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 10px;">
                    <button onclick="startMyBreak('Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…')" class="btn btn-success">ğŸ” Ø¨Ø±ÙŠÙƒ</button>
                    <button onclick="startMyBreak('ØµÙ„Ø§Ø©')" class="btn btn-info">ğŸ•Œ ØµÙ„Ø§Ø©</button>
                    <button onclick="startMyBreak('Ù…ÙŠØªÙ†Ø¬')" class="btn btn-warning">ğŸ¤ Ù…ÙŠØªÙ†Ø¬</button>
                    <button id="followUpBtn" onclick="startMyBreak('Ù…ØªØ§Ø¨Ø¹ Ø¹Ù…ÙŠÙ„')" class="btn btn-followup hidden">ğŸ“ Ù…ØªØ§Ø¨Ø¹</button>
                </div>
            </div>
            <div id="stopArea" class="hidden"><button onclick="stopMyBreak()" class="btn btn-danger" style="padding: 20px; width: 100%; font-size: 1.5rem; border-radius: 15px;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button></div>
        </div>
    </div>
</div>

<script>
    // --- Ù†ÙØ³ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ ---
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    let db;
    try { firebase.initializeApp(firebaseConfig); db = firebase.database(); } catch(e) { console.error(e); }

    let allUsersData = {}, currentUser = null, timerInterval = null, isLoaded = false, soundActive = false;
    let deptLimits = { "Ø·Ù„Ø¨Ø§Øª": 2, "ÙˆØ§ØªØ³Ø§Ø¨": 2, "Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª": 2, "prayers": 3 };
    let initialServerTime = Date.now(), initialPerformanceTime = performance.now();
    
    db.ref(".info/serverTimeOffset").on("value", (snap) => {
        initialServerTime = Date.now() + (snap.val() || 0);
        initialPerformanceTime = performance.now();
    });

    function getServerTime() { return initialServerTime + (performance.now() - initialPerformanceTime); }
    function getServerDateString() { const d = new Date(getServerTime()); return `${d.getDate().toString().padStart(2, '0')}/${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getFullYear()}`; }
    function getServerTimeString() { const d = new Date(getServerTime()); let h = d.getHours(); const m = d.getMinutes().toString().padStart(2, '0'), s = d.getSeconds().toString().padStart(2, '0'), ampm = h >= 12 ? 'PM' : 'AM'; h = h % 12 || 12; return `${h.toString().padStart(2, '0')}:${m}:${s} ${ampm}`; }

    const MANAGERS = ['mahmoud', 'abutamim', 'ahmed', 'admin'];

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…
    db.ref('settings/limits').on('value', (snap) => {
        if(snap.val()) {
            deptLimits = snap.val();
            if(document.getElementById('limit_talabat')) {
                document.getElementById('limit_talabat').value = deptLimits["Ø·Ù„Ø¨Ø§Øª"] || 2;
                document.getElementById('limit_whatsapp').value = deptLimits["ÙˆØ§ØªØ³Ø§Ø¨"] || 2;
                document.getElementById('limit_recievers').value = deptLimits["Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª"] || 2;
                document.getElementById('maxPrayersInput').value = deptLimits["prayers"] || 3;
            }
        }
    });

    db.ref('users').on('value', (snap) => {
        allUsersData = snap.val() || {};
        if (!isLoaded) { 
            isLoaded = true; 
            document.getElementById('loading').style.display = 'none'; 
            document.getElementById('mainContainer').classList.remove('hidden'); 
            checkSavedSession(); 
        }
        if (currentUser) {
            const updatedMe = allUsersData[currentUser.username];
            if(updatedMe) { 
                const role = currentUser.role; 
                currentUser = updatedMe; 
                currentUser.role = role; 
            }
            if (currentUser.role === 'admin') { 
                renderMonitorTable(); 
                renderAdminEmRequests(); 
                renderAdminOtRequests(); 
                renderUserManagementTable(); 
            } else { 
                updateUserUI(); 
                checkBreakLimit(); 
            }
        }
    });

    function attemptLogin() { 
        const u = document.getElementById('loginUser').value.trim().toLowerCase();
        const p = document.getElementById('loginPass').value.trim(); 
        if (allUsersData[u] && allUsersData[u].password === p) { 
            currentUser = allUsersData[u]; 
            currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee'; 
            localStorage.setItem('break_sys_user', u); 
            if (currentUser.role === 'admin') showAdmin(); else showEmployee();
        } else alert('Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©'); 
    }

    function checkSavedSession() { 
        const s = localStorage.getItem('break_sys_user'); 
        if (s && allUsersData[s]) { 
            currentUser = allUsersData[s]; 
            currentUser.role = MANAGERS.includes(s) ? 'admin' : 'employee'; 
            if (currentUser.role === 'admin') showAdmin(); else showEmployee(); 
        } 
    }

    function showAdmin() { 
        document.getElementById('loginSection').classList.add('hidden'); 
        document.getElementById('adminSection').classList.remove('hidden'); 
        document.getElementById('currentManagerDisplay').innerText = `Ø§Ù„Ù…Ø´Ø±Ù: ${currentUser.realName}`; 
        startGlobalTimer(); 
    }

    function showEmployee() { 
        document.getElementById('loginSection').classList.add('hidden'); 
        document.getElementById('employeeSection').classList.remove('hidden'); 
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName}`; 
        document.getElementById('myDeptDisplay').innerText = `Ø§Ù„Ù‚Ø³Ù…: ${currentUser.department || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}`;
        startGlobalTimer(); 
    }

    function startGlobalTimer() { 
        if(timerInterval) clearInterval(timerInterval); 
        timerInterval = setInterval(() => { 
            const sT = getServerTimeString();
            if(document.getElementById('adminServerTime')) document.getElementById('adminServerTime').innerText = sT;
            if(document.getElementById('userServerTime')) document.getElementById('userServerTime').innerText = sT;
            if(currentUser && currentUser.role === 'admin') updateMonitorValuesOnly(); else updateUserUI();
        }, 1000); 
    }

    function updateLimits() {
        const limits = {
            "Ø·Ù„Ø¨Ø§Øª": parseInt(document.getElementById('limit_talabat').value),
            "ÙˆØ§ØªØ³Ø§Ø¨": parseInt(document.getElementById('limit_whatsapp').value),
            "Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª": parseInt(document.getElementById('limit_recievers').value),
            "prayers": parseInt(document.getElementById('maxPrayersInput').value)
        };
        db.ref('settings/limits').set(limits).then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… âœ…"));
    }

    function checkBreakLimit() {
        if(!currentUser || currentUser.role === 'admin' || currentUser.isOnBreak) return;
        
        const myDept = currentUser.department || "Ø£Ø®Ø±Ù‰";
        const limit = deptLimits[myDept] || 99;
        
        // Ø¹Ø¯ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ø§Ù„Ù„ÙŠ ÙÙŠ Ù†ÙØ³ Ù‚Ø³Ù…ÙŠ ÙˆØ­Ø§Ù„ÙŠØ§Ù‹ ÙÙŠ Ø¨Ø±ÙŠÙƒ (Ø¹Ø§Ù… Ø£Ùˆ Ø·ÙˆØ§Ø±Ø¦)
        const activeInDept = Object.values(allUsersData).filter(u => 
            u.department === myDept && 
            u.isOnBreak && 
            (u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || u.breakType === 'Ø·ÙˆØ§Ø±Ø¦')
        ).length;

        const box = document.getElementById('breakLimitAlert');
        if(activeInDept >= limit) {
            box.style.display = 'block';
            box.innerText = `âš ï¸ Ù‚Ø³Ù… "${myDept}" ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ (${limit}/${limit}). Ø¨Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠØ¹ÙˆØ¯ Ø£Ø­Ø¯ Ø²Ù…Ù„Ø§Ø¦Ùƒ.`;
        } else {
            box.style.display = 'none';
        }
    }

    function startMyBreak(type) {
        if(currentUser.isOnBreak) return;

        const myDept = currentUser.department || "Ø£Ø®Ø±Ù‰";
        const limit = deptLimits[myDept] || 99;
        const activeInDept = Object.values(allUsersData).filter(u => u.department === myDept && u.isOnBreak && (u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || u.breakType === 'Ø·ÙˆØ§Ø±Ø¦')).length;

        if((type === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || type === 'Ø·ÙˆØ§Ø±Ø¦') && activeInDept >= limit) {
            return alert(`Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„Ø®Ø±ÙˆØ¬ Ø­Ø§Ù„ÙŠØ§Ù‹. Ù‚Ø³Ù… ${myDept} ÙˆØµÙ„ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ (${limit}).`);
        }

        const reason = document.getElementById('breakReason').value.trim();
        if(!reason && type !== 'ØµÙ„Ø§Ø©') return alert("Ø¨Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø³Ø¨Ø¨ Ø£ÙˆÙ„Ø§Ù‹");

        db.ref('users/' + currentUser.username).update({
            isOnBreak: true,
            breakType: type,
            lastStartTime: getServerTime(),
            lastReason: reason || type
        });
    }

    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        let counts = { "Ø·Ù„Ø¨Ø§Øª": 0, "ÙˆØ§ØªØ³Ø§Ø¨": 0, "Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª": 0 };

        Object.values(allUsersData).forEach(u => {
            if (!u.username || MANAGERS.includes(u.username)) return;
            
            if(u.isOnBreak && (u.breakType==='Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || u.breakType==='Ø·ÙˆØ§Ø±Ø¦')) {
                if(counts[u.department] !== undefined) counts[u.department]++;
            }

            let lg = u.usedSeconds || 0;
            if (u.isOnBreak && u.lastStartTime && (u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || u.breakType === 'Ø·ÙˆØ§Ø±Ø¦')) {
                lg += Math.floor((getServerTime() - u.lastStartTime) / 1000);
            }
            const rem = ((u.allowance || 45) * 60) - lg;
            const deptClass = u.department === 'Ø·Ù„Ø¨Ø§Øª' ? 'bg-talabat' : u.department === 'ÙˆØ§ØªØ³Ø§Ø¨' ? 'bg-whatsapp' : u.department === 'Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª' ? 'bg-recievers' : 'bg-other';

            tbody.innerHTML += `
                <tr>
                    <td>${u.realName}</td>
                    <td><span class="dept-badge ${deptClass}">${u.department || '---'}</span></td>
                    <td>${u.isOnBreak ? `<b style="color:red">${u.breakType}</b>` : '<b style="color:green">Ù…ØªØ§Ø­</b>'}</td>
                    <td id="rem_${u.username}">${formatTime(rem)}</td>
                    <td>${formatTime(u.prayerSeconds || 0)}</td>
                    <td>
                        ${u.isOnBreak ? `<button onclick="adminStop('${u.username}')" class="btn btn-danger btn-sm">Ø¥ÙŠÙ‚Ø§Ù</button>` : `<button onclick="adminStart('${u.username}')" class="btn btn-success btn-sm">Ø¨Ø¯Ø¡ Ø¨Ø±ÙŠÙƒ</button>`}
                    </td>
                </tr>
            `;
        });

        document.getElementById('statusCountersDisplay').innerHTML = `
            <b>Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø­Ø§Ù„ÙŠØ§Ù‹:</b> 
            | Ø·Ù„Ø¨Ø§Øª: (${counts["Ø·Ù„Ø¨Ø§Øª"]}/${deptLimits["Ø·Ù„Ø¨Ø§Øª"]}) 
            | ÙˆØ§ØªØ³Ø§Ø¨: (${counts["ÙˆØ§ØªØ³Ø§Ø¨"]}/${deptLimits["ÙˆØ§ØªØ³Ø§Ø¨"]}) 
            | Ù…ØªÙ„Ù‚ÙŠ: (${counts["Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª"]}/${deptLimits["Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª"]})
        `;
    }

    // --- Ø§Ù„ÙˆØ¸Ø§Ø¦Ù Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© (ØªÙƒÙ…Ù„Ø© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ) ---
    function formatTime(s) { 
        const abs = Math.abs(s);
        const m = Math.floor(abs/60).toString().padStart(2,'0');
        const sec = (abs%60).toString().padStart(2,'0');
        return (s < 0 ? "-" : "") + m + ":" + sec; 
    }

    function stopMyBreak() {
        const u = currentUser;
        const duration = Math.floor((getServerTime() - u.lastStartTime) / 1000);
        const updates = { isOnBreak: false, lastStartTime: null };
        
        if(u.breakType==='Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || u.breakType==='Ø·ÙˆØ§Ø±Ø¦') updates.usedSeconds = (u.usedSeconds||0) + duration;
        else if(u.breakType==='ØµÙ„Ø§Ø©') updates.prayerSeconds = (u.prayerSeconds||0) + duration;

        db.ref('users/'+u.username+'/sessions').push({
            date: getServerDateString(),
            type: u.breakType,
            duration: duration,
            reason: u.lastReason
        });
        db.ref('users/'+u.username).update(updates);
    }

    function saveUser() {
        const un = document.getElementById('newUsername').value.trim().toLowerCase();
        const data = {
            realName: document.getElementById('newRealName').value,
            password: document.getElementById('newPassword').value,
            allowance: parseInt(document.getElementById('newAllowance').value),
            department: document.getElementById('newDepartment').value,
            isVIP: document.getElementById('isVIPUser').checked,
            canFollowUp: document.getElementById('canFollowUp').checked,
            username: un,
            usedSeconds: 0,
            prayerSeconds: 0,
            isOnBreak: false
        };
        db.ref('users/'+un).update(data).then(() => {
            alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù ÙˆØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… âœ…");
            resetUserForm();
        });
    }

    function updateUserUI() {
        if(!currentUser || currentUser.role === 'admin') return;
        const u = currentUser;
        const timer = document.getElementById('userTimer');
        const msg = document.getElementById('userStatusMsg');
        
        if(u.isOnBreak) {
            document.getElementById('controlsArea').classList.add('hidden');
            document.getElementById('stopArea').classList.remove('hidden');
            msg.innerText = "Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ: " + u.breakType;
            // ØªØ­Ø¯ÙŠØ« Ø§Ù„ØªØ§ÙŠÙ…Ø± Ù„Ø§ÙŠÙ
        } else {
            document.getElementById('controlsArea').classList.remove('hidden');
            document.getElementById('stopArea').classList.add('hidden');
            msg.innerText = "Ø£Ù†Øª Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„";
        }
    }

    function logout() { localStorage.removeItem('break_sys_user'); location.reload(); }
    function switchAdminTab(t) { 
        ['tab-monitor','tab-reports','tab-users','tab-overtime','tab-emergency'].forEach(id => document.getElementById(id).classList.add('hidden')); 
        document.getElementById('tab-'+t).classList.remove('hidden'); 
    }
    function resetUserForm() { document.getElementById('newUsername').value=''; document.getElementById('newRealName').value=''; }
    function enableSound() { soundActive = true; alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„ØµÙˆØªÙŠØ©"); }

</script>
</body>
</html>
