<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ·ÙˆØ± - Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ø´Ø±Ù Ù…Ø­Ù…ÙˆØ¯</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f1c40f;
            --meeting-color: #f39c12;
            --prayer-color: #2980b9;
            --emergency-color: #c0392b;
            --followup-color: #16a085;
            --dark-text: #2d3436;
            --vip-color: #f39c12;
        }

        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; padding: 20px 10px; min-height: 100vh; color: var(--dark-text); }
        
        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; margin-bottom: 20px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-family: 'Cairo', sans-serif; color: white; transition: all 0.3s ease; margin: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #2980b9; } 
        .btn-danger { background: #c0392b; } 
        .btn-success { background: #27ae60; } 
        .btn-warning { background: #f39c12; } 
        .btn-info { background: #8e44ad; } 
        .btn-dark { background: #2d3436; } 
        .btn-vip { background: linear-gradient(45deg, #d4af37, #f1c40f); color: #000; }

        input, select { padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: 'Cairo', sans-serif; }

        .table-responsive { width: 100%; overflow-x: auto; margin-top: 15px; border-radius: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; min-width: 850px; border: 1px solid #ddd; }
        th { background: #2c3e50; color: white; padding: 15px 10px; font-size: 0.9rem; text-align: center; border: 1px solid #34495e; }
        td { padding: 12px 10px; text-align: center; border-bottom: 1px solid #eee; font-size: 0.9rem; border-left: 1px solid #eee; }

        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .hidden { display: none !important; }
        
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ØªÙ‚Ø¯Ù… */
        .movement-log-list { list-style: none; padding: 0; margin: 0; text-align: right; }
        .movement-log-item { display: flex; justify-content: flex-end; align-items: center; gap: 10px; padding: 6px 0; border-bottom: 1px dashed #eee; }
        .del-btn-report { background: #e74c3c; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 2px 8px; font-size: 0.75rem; font-family: 'Cairo'; }
        .del-btn-report:hover { background: #c0392b; }
        
        .oxidation-red { color: #e74c3c; font-weight: bold; }
        .dept-badge { font-size: 0.7rem; padding: 2px 6px; border-radius: 5px; color: white; font-weight: bold; }
        .bg-talabat { background: #e67e22; }
        .bg-whatsapp { background: #27ae60; }
        .bg-recievers { background: #8e44ad; }

        .server-clock-box { background: #2c3e50; color: #fff; padding: 8px 20px; border-radius: 12px; text-align: center; }
        .clock-time { font-size: 1.1rem; font-weight: 800; color: #2ecc71; display: block; }

        #loading { position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; }
        .spinner { border:5px solid #f3f3f3; border-top:5px solid #2c3e50; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner"></div>
    <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h3>
</div>

<div class="container hidden" id="mainContainer">
    
    <!-- Ù‚Ø³Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
    <div id="loginSection">
        <h2>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…</h2>
        <div style="max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding: 15px;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <!-- Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø´Ø±Ù -->
    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <div>
                <h3 id="currentManagerDisplay" style="margin:0; text-align:right;"></h3>
                <button onclick="logout()" class="btn btn-dark btn-sm">ØªØ³Ø¬ÙŠÙ„ Ø®Ø±ÙˆØ¬</button>
            </div>
            <div class="server-clock-box">
                <span id="adminServerTime" class="clock-time">00:00:00</span>
                <span id="adminServerDate" style="font-size: 0.7rem;">--/--/----</span>
            </div>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary btn-sm">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning btn-sm">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø£Ø±Ø´ÙŠÙ</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success btn-sm">âš™ï¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© -->
        <div id="tab-monitor">
            <div id="statusCountersDisplay" style="text-align:right; font-weight:bold; margin-bottom:15px; background: #f8f9fa; padding: 10px; border-radius: 10px;"></div>
            <div class="table-responsive">
                <table id="monitorTable">
                    <thead>
                        <tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</th><th>Ø§Ù„ØµÙ„Ø§Ø©</th><th>ØªØ­ÙƒÙ…</th></tr>
                    </thead>
                    <tbody id="monitorBody"></tbody>
                </table>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± (Ø§Ù„Ù…Ø¹Ø¯Ù„ Ø­Ø³Ø¨ Ø·Ù„Ø¨Ùƒ) -->
        <div id="tab-reports" class="hidden">
            <div style="background: #f8f9fa; padding: 20px; border-radius: 15px; border: 1px solid #ddd; margin-bottom: 20px;">
                <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                    <div style="flex: 1; min-width: 200px;">
                        <label>Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù:</label>
                        <select id="reportUserSelect"><option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option></select>
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label>Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="filterStartDate">
                    </div>
                    <div style="flex: 1; min-width: 150px;">
                        <label>Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                        <input type="date" id="filterEndDate">
                    </div>
                </div>
                <button onclick="renderUserReport()" class="btn btn-primary" style="width:100%; margin-top: 15px; height: 45px;">ğŸ” Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…ÙÙ„ØªØ±</button>
                <button id="masterDeleteBtn" onclick="deleteAllReports()" class="btn btn-danger hidden" style="width:100%; margin-top: 10px; font-weight: bold;">âš ï¸ Ø­Ø°Ù Ø£Ø±Ø´ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ (Ù…Ø­Ù…ÙˆØ¯ ÙÙ‚Ø·)</button>
            </div>

            <div class="table-responsive">
                <table>
                    <thead>
                        <tr style="background: #2c3e50; color: white;">
                            <th style="width: 15%;">Ø§Ù„ÙŠÙˆÙ…</th>
                            <th style="width: 55%;">Ø³Ø¬Ù„ Ø§Ù„ØªØ­Ø±ÙƒØ§Øª</th>
                            <th style="width: 15%;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ</th>
                            <th style="width: 15%;">ØµØ§ÙÙŠ Ø§Ù„Ø£ÙƒØ³Ø¯Ø©</th>
                        </tr>
                    </thead>
                    <tbody id="sessionsReportBody"></tbody>
                </table>
            </div>

            <div style="margin-top: 30px;">
                <h4 style="color: #8e44ad; border-bottom: 2px solid #eee; padding-bottom: 5px;">ğŸ“„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯</h4>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr style="background: #2c3e50; color: white;">
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ§ÙÙ‚Ø©</th>
                                <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø³Ø§Ø¹Ø§Øª</th>
                                <th>Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´Ø±Ù</th>
                            </tr>
                        </thead>
                        <tbody id="approvedOtBody">
                            <tr><td colspan="3">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- ØªØ¨ÙˆÙŠØ¨ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† -->
        <div id="tab-users" class="hidden">
            <div style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;">
                <h4>Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù Ø¬Ø¯ÙŠØ¯</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„">
                    <input type="text" id="newUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
                    <input type="text" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <input type="number" id="newAllowance" placeholder="Ø§Ù„Ø¯Ù‚Ø§Ø¦Ù‚ Ø§Ù„Ù…Ø³Ù…ÙˆØ­Ø©" value="45">
                    <select id="newDepartment">
                        <option value="Ø·Ù„Ø¨Ø§Øª">Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                        <option value="ÙˆØ§ØªØ³Ø§Ø¨">Ù‚Ø³Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨</option>
                        <option value="Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª">Ù‚Ø³Ù… Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª</option>
                    </select>
                </div>
                <button onclick="saveUser()" class="btn btn-success" style="width:100%; margin-top:10px;">Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¸Ù</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Ø§Ù„Ø±ØµÙŠØ¯</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                    <tbody id="usersManagementBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="employeeSection" class="hidden">
        <div style="text-align: center;">
            <h2 id="welcomeMsg"></h2>
            <div style="background: #2c3e50; color: white; padding: 30px; border-radius: 20px; margin: 20px 0;">
                <div style="font-size: 1rem; opacity: 0.8;">Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                <div id="userTimer" style="font-size: 4rem; font-weight: 800; color: #2ecc71;">00:00</div>
                <div id="userStatusMsg" style="font-size: 1.2rem; margin-top: 10px;">Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„</div>
            </div>

            <div id="controlsArea">
                <input type="text" id="breakReason" placeholder="Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨ Ù‡Ù†Ø§..." style="text-align: center; max-width: 400px;">
                <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                    <button onclick="startMyBreak('Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…')" class="btn btn-success" style="width: 120px;">ğŸ” Ø¨Ø±ÙŠÙƒ</button>
                    <button onclick="startMyBreak('ØµÙ„Ø§Ø©')" class="btn btn-info" style="width: 120px;">ğŸ•Œ ØµÙ„Ø§Ø©</button>
                    <button onclick="startMyBreak('Ù…ÙŠØªÙ†Ø¬')" class="btn btn-warning" style="width: 120px;">ğŸ¤ Ù…ÙŠØªÙ†Ø¬</button>
                </div>
            </div>
            <div id="stopArea" class="hidden">
                <button onclick="stopMyBreak()" class="btn btn-danger" style="width: 100%; height: 80px; font-size: 1.5rem;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡ Ø§Ù„Ù†Ø´Ø§Ø·</button>
            </div>
            <button onclick="logout()" class="btn btn-dark" style="margin-top: 30px;">Ø®Ø±ÙˆØ¬</button>
        </div>
    </div>
</div>

<script>
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null;
    let allUsersData = {};
    const MANAGERS = ['mahmoud', 'admin', 'abutamim'];

    // Ù…Ø±Ø§Ù‚Ø¨Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    db.ref('users').on('value', (snap) => {
        allUsersData = snap.val() || {};
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContainer').classList.remove('hidden');

        if (currentUser) {
            currentUser = allUsersData[currentUser.username];
            if (MANAGERS.includes(currentUser.username)) {
                renderMonitorTable();
                updateReportSelect();
            } else {
                updateEmployeeUI();
            }
        } else {
            checkSavedSession();
        }
    });

    // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
    setInterval(() => {
        const now = new Date();
        const timeStr = now.toLocaleTimeString('en-GB');
        const dateStr = now.toLocaleDateString('ar-EG');
        if (document.getElementById('adminServerTime')) {
            document.getElementById('adminServerTime').innerText = timeStr;
            document.getElementById('adminServerDate').innerText = dateStr;
        }
    }, 1000);

    function attemptLogin() {
        const u = document.getElementById('loginUser').value.trim().toLowerCase();
        const p = document.getElementById('loginPass').value.trim();

        if (allUsersData[u] && allUsersData[u].password === p) {
            currentUser = allUsersData[u];
            localStorage.setItem('break_sys_user', u);
            if (MANAGERS.includes(u)) showAdmin(); else showEmployee();
        } else {
            alert("Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        }
    }

    function checkSavedSession() {
        const saved = localStorage.getItem('break_sys_user');
        if (saved && allUsersData[saved]) {
            currentUser = allUsersData[saved];
            if (MANAGERS.includes(saved)) showAdmin(); else showEmployee();
        }
    }

    function showAdmin() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('adminSection').classList.remove('hidden');
        document.getElementById('currentManagerDisplay').innerText = `Ø§Ù„Ù…Ø´Ø±Ù: ${currentUser.realName}`;
        if(currentUser.username === 'mahmoud') document.getElementById('masterDeleteBtn').classList.remove('hidden');
    }

    function showEmployee() {
        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('employeeSection').classList.remove('hidden');
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${currentUser.realName}`;
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙÙŠ Ø§Ù„ØµÙˆØ±)
    function renderUserReport() {
        const targetId = document.getElementById('reportUserSelect').value;
        const start = document.getElementById('filterStartDate').value;
        const end = document.getElementById('filterEndDate').value;

        if (!targetId) return alert("Ø§Ø®ØªØ± Ø§Ù„Ù…ÙˆØ¸Ù Ø£ÙˆÙ„Ø§Ù‹");

        const sessions = allUsersData[targetId].sessions || {};
        const allowance = allUsersData[targetId].allowance || 45;
        const tbody = document.getElementById('sessionsReportBody');
        tbody.innerHTML = '';

        let grouped = {};
        Object.keys(sessions).forEach(key => {
            const s = sessions[key];
            const date = s.date;
            
            if (start && end) {
                const sDate = new Date(start); const eDate = new Date(end);
                const [d, m, y] = date.split('/');
                const currentD = new Date(`${y}-${m}-${d}`);
                if (currentD < sDate || currentD > eDate) return;
            }

            if (!grouped[date]) grouped[date] = { total: 0, logs: [] };
            if (s.type === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…' || s.type.includes('Ø§Ø³ØªØ±Ø§Ø­Ø©')) grouped[date].total += s.duration;
            grouped[date].logs.push({ ...s, id: key });
        });

        Object.keys(grouped).sort().reverse().forEach(date => {
            const data = grouped[date];
            const totalMin = Math.floor(data.total / 60);
            const oxidation = totalMin > allowance ? (totalMin - allowance) : 0;

            let logsHtml = `<ul class="movement-log-list">`;
            data.logs.forEach(log => {
                logsHtml += `
                    <li class="movement-log-item">
                        <span>${log.type}: [${Math.floor(log.duration/60)}Ø¯] - Ø§Ù„Ø³Ø¨Ø¨: ${log.reason || '---'}</span>
                        <button class="del-btn-report" onclick="deleteSession('${targetId}', '${log.id}')">Ø­Ø°Ù</button>
                    </li>`;
            });
            logsHtml += `</ul>`;

            tbody.innerHTML += `
                <tr>
                    <td style="font-weight:bold;">${date}</td>
                    <td>${logsHtml}</td>
                    <td style="color:#27ae60; font-weight:bold;">${totalMin} Ø¯</td>
                    <td class="${oxidation > 0 ? 'oxidation-red' : ''}">${oxidation} Ø¯</td>
                </tr>
            `;
        });
    }

    function deleteSession(uid, sid) {
        if(confirm("Ø­Ø°Ù Ù‡Ø°Ù‡ Ø§Ù„Ø­Ø±ÙƒØ© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) {
            db.ref(`users/${uid}/sessions/${sid}`).remove().then(() => renderUserReport());
        }
    }

    function deleteAllReports() {
        if(confirm("âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø£Ø±Ø´ÙŠÙ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹! Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ")) {
            Object.keys(allUsersData).forEach(u => {
                db.ref(`users/${u}/sessions`).remove();
                db.ref(`users/${u}/usedSeconds`).set(0);
                db.ref(`users/${u}/prayerSeconds`).set(0);
            });
            alert("ØªÙ… ØªØµÙÙŠØ± Ø§Ù„Ø£Ø±Ø´ÙŠÙ Ø¨Ù†Ø¬Ø§Ø­");
        }
    }

    // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ù„Ù„Ù…ÙˆØ¸Ù
    function startMyBreak(type) {
        const reason = document.getElementById('breakReason').value.trim();
        if(!reason && type !== 'ØµÙ„Ø§Ø©') return alert("Ø§ÙƒØªØ¨ Ø§Ù„Ø³Ø¨Ø¨");
        
        db.ref(`users/${currentUser.username}`).update({
            isOnBreak: true,
            breakType: type,
            lastStartTime: Date.now(),
            lastReason: reason || type
        });
    }

    function stopMyBreak() {
        const u = currentUser;
        const duration = Math.floor((Date.now() - u.lastStartTime) / 1000);
        const dateStr = new Date().toLocaleDateString('en-GB');

        db.ref(`users/${u.username}/sessions`).push({
            date: dateStr,
            type: u.breakType,
            duration: duration,
            reason: u.lastReason
        });

        const updates = { isOnBreak: false };
        if(u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…') updates.usedSeconds = (u.usedSeconds || 0) + duration;
        if(u.breakType === 'ØµÙ„Ø§Ø©') updates.prayerSeconds = (u.prayerSeconds || 0) + duration;

        db.ref(`users/${u.username}`).update(updates);
    }

    function updateEmployeeUI() {
        const u = currentUser;
        const timer = document.getElementById('userTimer');
        const stopArea = document.getElementById('stopArea');
        const ctrlArea = document.getElementById('controlsArea');

        if (u.isOnBreak) {
            ctrlArea.classList.add('hidden');
            stopArea.classList.remove('hidden');
            const elapsed = Math.floor((Date.now() - u.lastStartTime) / 1000);
            timer.innerText = formatTime(elapsed);
            document.getElementById('userStatusMsg').innerText = `Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ: ${u.breakType}`;
        } else {
            ctrlArea.classList.remove('hidden');
            stopArea.classList.add('hidden');
            const rem = ((u.allowance || 45) * 60) - (u.usedSeconds || 0);
            timer.innerText = formatTime(rem);
            timer.style.color = rem < 0 ? "#e74c3c" : "#2ecc71";
            document.getElementById('userStatusMsg').innerText = "Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ù…Ù„";
        }
    }

    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            if (MANAGERS.includes(u.username)) return;
            const deptClass = u.department === 'Ø·Ù„Ø¨Ø§Øª' ? 'bg-talabat' : u.department === 'ÙˆØ§ØªØ³Ø§Ø¨' ? 'bg-whatsapp' : 'bg-recievers';
            tbody.innerHTML += `
                <tr>
                    <td>${u.realName}</td>
                    <td><span class="dept-badge ${deptClass}">${u.department}</span></td>
                    <td>${u.isOnBreak ? `<b style="color:red">${u.breakType}</b>` : '<b style="color:green">Ù…ØªØ§Ø­</b>'}</td>
                    <td>${formatTime(((u.allowance||45)*60) - (u.usedSeconds||0))}</td>
                    <td>${formatTime(u.prayerSeconds||0)}</td>
                    <td><button onclick="adminStop('${u.username}')" class="btn btn-danger btn-sm">Ø¥ÙŠÙ‚Ø§Ù</button></td>
                </tr>
            `;
        });
    }

    function updateReportSelect() {
        const sel = document.getElementById('reportUserSelect');
        if(sel.options.length > 1) return;
        Object.values(allUsersData).forEach(u => {
            if(!MANAGERS.includes(u.username)) sel.innerHTML += `<option value="${u.username}">${u.realName}</option>`;
        });
    }

    function saveUser() {
        const un = document.getElementById('newUsername').value.toLowerCase();
        db.ref(`users/${un}`).set({
            realName: document.getElementById('newRealName').value,
            password: document.getElementById('newPassword').value,
            allowance: parseInt(document.getElementById('newAllowance').value),
            department: document.getElementById('newDepartment').value,
            username: un,
            usedSeconds: 0,
            prayerSeconds: 0,
            isOnBreak: false
        }).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ©"));
    }

    function adminStop(un) {
        if(confirm("Ø¥ÙŠÙ‚Ø§Ù Ù†Ø´Ø§Ø· Ø§Ù„Ù…ÙˆØ¸ÙØŸ")) {
            const u = allUsersData[un];
            const duration = Math.floor((Date.now() - u.lastStartTime) / 1000);
            db.ref(`users/${un}/sessions`).push({
                date: new Date().toLocaleDateString('en-GB'),
                type: u.breakType,
                duration: duration,
                reason: "Ø¥ÙŠÙ‚Ø§Ù Ø¨ÙˆØ§Ø³Ø·Ø© Ø§Ù„Ù…Ø´Ø±Ù"
            });
            db.ref(`users/${un}`).update({ isOnBreak: false, usedSeconds: (u.usedSeconds||0) + (u.breakType==='Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…'?duration:0) });
        }
    }

    function formatTime(s) {
        const abs = Math.abs(s);
        const m = Math.floor(abs/60).toString().padStart(2,'0');
        const sec = (abs%60).toString().padStart(2,'0');
        return (s < 0 ? "-" : "") + m + ":" + sec;
    }

    function switchAdminTab(t) {
        ['tab-monitor', 'tab-reports', 'tab-users'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('tab-' + t).classList.remove('hidden');
    }

    function logout() { localStorage.removeItem('break_sys_user'); location.reload(); }

</script>
</body>
</html>
