<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨Ø±ÙŠÙƒ ÙˆØ§Ù„Ø£ÙƒØ³Ø¯Ø© ÙˆØ§Ù„Ø£Ù‚Ø³Ø§Ù…</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e74c3c;
            --success-color: #27ae60;
            --warning-color: #f1c40f;
            --meeting-color: #f39c12;
            --prayer-color: #2980b9;
            --emergency-color: #c0392b;
            --followup-color: #16a085;
            --dark-text: #2d3436;
            --vip-color: #f39c12;
        }

        body { font-family: 'Cairo', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); margin: 0; padding: 20px 10px; min-height: 100vh; color: var(--dark-text); }
        
        @keyframes flash-red { 0% { background-color: #ffcccc; } 50% { background-color: #ff0000; box-shadow: 0 0 20px red; } 100% { background-color: #ffcccc; } }
        .ÙˆØ¶Ø¹-Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ { animation: flash-red 0.8s infinite; }
        .ØµÙ-ØªØ­Ø°ÙŠØ± { background-color: #fff9c4 !important; }

        .container { max-width: 1200px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        h2, h3 { color: #2c3e50; text-align: center; font-weight: 700; margin-bottom: 20px; }
        
        .btn { padding: 10px 15px; border: none; border-radius: 10px; cursor: pointer; font-weight: 700; font-family: 'Cairo', sans-serif; color: white; transition: all 0.3s ease; margin: 3px; font-size: 0.9rem; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #2980b9; } .btn-danger { background: #c0392b; } .btn-success { background: #27ae60; } .btn-warning { background: #f39c12; } .btn-info { background: #8e44ad; } .btn-dark { background: #2d3436; } .btn-purple { background: #8e44ad; } .btn-followup { background: var(--followup-color); } .btn-vip { background: linear-gradient(45deg, #d4af37, #f1c40f); border: 1px solid #b8860b; color: #000; }
        
        input, select { padding: 10px; border: 2px solid #e0e0e0; border-radius: 10px; width: 100%; box-sizing: border-box; margin-bottom: 10px; font-family: 'Cairo', sans-serif; font-size: 0.95rem; }
        input:focus { outline: none; border-color: var(--primary-color); background: #fff; }

        .table-responsive { width: 100%; overflow-x: auto; margin-top: 15px; border-radius: 10px; }
        table { width: 100%; border-collapse: separate; border-spacing: 0; background: white; min-width: 850px; }
        th { background: #2c3e50; color: white; padding: 12px 8px; font-size: 0.85rem; }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.85rem; vertical-align: middle; }

        .nav-tabs { display: flex; gap: 5px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; }
        .hidden { display: none !important; }
        
        .timer-display { font-size: 3rem; font-weight: 800; color: var(--primary-color); margin: 10px 0; }
        .timer-label { font-size: 1.1rem; color: #777; font-weight: 700; }
        
        .summary-card { background: white; border: 2px solid #2ecc71; padding: 10px; border-radius: 10px; margin-bottom: 15px; display: flex; justify-content: space-around; flex-wrap: wrap; gap: 10px; }
        .summary-item { text-align: center; min-width: 120px; }
        .summary-item p { margin: 2px 0 0; font-size: 1.1rem; font-weight: bold; color: #27ae60; }
        
        .online-dot { height: 12px; width: 12px; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .dot-green { background-color: #2ecc71; box-shadow: 0 0 8px #2ecc71; }
        .dot-grey { background-color: #95a5a6; }
        
        .admin-table-ctrl { display: flex; flex-direction: column; gap: 5px; max-width: 220px; margin: auto; padding: 5px; background: #fdfdfd; border-radius: 8px; border: 1px solid #eee; }
        .admin-row-top { display: flex; gap: 4px; }
        .admin-row-top select { margin: 0; height: 38px; flex: 1.5; font-size: 0.8rem; border: 2px solid #ddd; }
        .activity-text { font-size: 0.75rem; color: #555; text-align: right; line-height: 1.5; display: block; padding: 2px 0; border-bottom: 1px dashed #eee; }
        
        .dept-tag { font-size: 0.7rem; padding: 2px 6px; border-radius: 4px; background: #eee; color: #666; font-weight: bold; display: block; margin-top: 3px; }

        .limit-box { background: #f8f9fa; border: 1px solid #eee; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .limit-input-group { background: white; border: 1px solid #ddd; padding: 8px 15px; border-radius: 12px; display: flex; align-items: center; gap: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }

        #broadcastOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000; display: none; flex-direction: column;
            align-items: center; justify-content: center; color: white;
            text-align: center; padding: 20px;
        }
        .broadcast-content {
            background: white; color: #2c3e50; padding: 40px;
            border-radius: 30px; max-width: 600px; width: 90%;
            box-shadow: 0 0 50px rgba(231, 76, 60, 1);
            border: 8px solid #e74c3c;
            animation: pulse-emergency 1s infinite;
        }

        #bottomToast {
            position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%);
            background: #e74c3c; color: white; padding: 15px 30px;
            border-radius: 50px; font-weight: bold; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            z-index: 99999; transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex; align-items: center; gap: 10px; min-width: 300px; justify-content: center;
        }
        #bottomToast.show { bottom: 30px; }

        .notification-log {
            margin-top: 20px; background: #fff; border-radius: 15px;
            border: 1px solid #eee; overflow: hidden; text-align: right;
        }
        .log-header { background: #f8f9fa; padding: 10px 15px; border-bottom: 1px solid #eee; font-weight: bold; }
        .log-body { max-height: 200px; overflow-y: auto; padding: 10px; }
        .log-item { padding: 8px; border-bottom: 1px solid #f9f9f9; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
    </style>
</head>
<body>

<div id="loading" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center;">
    <div style="border:5px solid #f3f3f3; border-top:5px solid #2c3e50; border-radius:50%; width:50px; height:50px; animation:spin 1s linear infinite;"></div>
    <h3>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…...</h3>
</div>

<audio id="alarmSound" loop preload="auto"><source src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" type="audio/ogg"></audio>
<audio id="notifySound" preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/2358/2358-preview.mp3" type="audio/mp3"></audio>
<audio id="requestRing" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/1110/1110-preview.mp3" type="audio/mp3"></audio>
<audio id="broadcastSound" loop preload="auto"><source src="https://assets.mixkit.co/active_storage/sfx/951/951-preview.mp3" type="audio/mp3"></audio>

<div id="broadcastOverlay">
    <div class="broadcast-content">
        <h1 style="color: #c0392b;">ØªÙ†Ø¨ÙŠÙ‡ Ø¥Ø¯Ø§Ø±ÙŠ Ø¹Ø§Ø¬Ù„</h1>
        <p id="broadcastMsgText" style="font-size: 1.5rem; font-weight: bold;"></p>
        <button onclick="acknowledgeBroadcast()" class="btn btn-danger" style="width: 100%;">ÙÙ‡Ù…Øª âœ…</button>
    </div>
</div>

<div id="bottomToast">
    <span>ğŸ“¢</span>
    <span id="toastText">Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ù† Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©</span>
</div>

<div class="container hidden" id="mainContainer">
    
    <div id="loginSection">
        <h2>ğŸ‘‹ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
        <div style="max-width: 400px; margin: auto; background: #fff; padding: 20px; border-radius: 15px; border: 1px solid #eee;">
            <input type="text" id="loginUser" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…">
            <input type="password" id="loginPass" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
            <button onclick="attemptLogin()" class="btn btn-primary" style="width:100%; padding: 15px;">Ø¯Ø®ÙˆÙ„</button>
        </div>
    </div>

    <div id="adminSection" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px;">
            <div>
                <h2 style="margin:0;">Ù„ÙˆØ­Ø© Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ğŸš€</h2>
                <button onclick="enableSound()" class="btn btn-sm btn-info" id="soundBtn">ğŸ”Š ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª</button>
            </div>
            <button onclick="logout()" class="btn btn-dark btn-sm">Ø®Ø±ÙˆØ¬</button>
        </div>

        <div class="nav-tabs">
            <button onclick="switchAdminTab('monitor')" class="btn btn-primary btn-sm">ğŸ“¡ Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø©</button>
            <button onclick="switchAdminTab('reports')" class="btn btn-warning btn-sm">ğŸ“Š Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±</button>
            <button onclick="switchAdminTab('users')" class="btn btn-success btn-sm">âš™ï¸ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ†</button>
        </div>

        <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø±Ø§Ù‚Ø¨Ø© ÙˆØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø­Ø¯ÙˆØ¯ Ù„ÙƒÙ„ Ù‚Ø³Ù… -->
        <div id="tab-monitor">
            <h4 style="text-align:center;">âš–ï¸ Ø¶Ø¨Ø· Ø­Ø¯ÙˆØ¯ Ø¨Ø±ÙŠÙƒ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h4>
            <div class="limit-box">
                <div class="limit-input-group">
                    <strong>ğŸ“¦ Ø·Ù„Ø¨Ø§Øª:</strong>
                    <input type="number" id="limit_requests" style="width:50px;" min="1" value="2">
                </div>
                <div class="limit-input-group">
                    <strong>ğŸ’¬ ÙˆØ§ØªØ³:</strong>
                    <input type="number" id="limit_whatsapp" style="width:50px;" min="1" value="2">
                </div>
                <div class="limit-input-group">
                    <strong>ğŸ§ Ù…ØªÙ„Ù‚ÙŠ:</strong>
                    <input type="number" id="limit_receivers" style="width:50px;" min="1" value="2">
                </div>
                <button onclick="updateLimits()" class="btn btn-dark btn-sm">Ø­ÙØ¸ Ø§Ù„Ø­Ø¯ÙˆØ¯</button>
            </div>

            <div id="statusCountersDisplay" style="text-align:center; font-weight:bold; margin-bottom:15px; background: #eee; padding: 10px; border-radius: 10px;">
                Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª Ø³ØªØ¸Ù‡Ø± Ù‡Ù†Ø§
            </div>
            
            <div class="table-responsive">
                <table id="monitorTable">
                    <thead><tr><th>Ø§Ù„Ù…ÙˆØ¸Ù</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ø§Ù„Ø¨Ø±ÙŠÙƒ (Ù…ØªØ¨Ù‚ÙŠ)</th><th>ØµÙ„Ø§Ø© / Ù…ØªØ¨Ø¹</th><th>ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø´Ø±Ù</th></tr></thead>
                    <tbody id="monitorBody"></tbody>
                </table>
            </div>
        </div>

        <div id="tab-reports" class="hidden">
            <select id="reportUserSelect" onchange="renderUserReport()"><option value="">-- Ø§Ø®ØªØ± Ù…ÙˆØ¸Ù --</option></select>
            <div class="summary-card hidden" id="monthlySummary">
                <div class="summary-item"><h5>ØµØ§ÙÙŠ Ø§Ù„Ø£ÙƒØ³Ø¯Ø©</h5><p id="monthTotalBreaks">0</p></div>
                <div class="summary-item"><h5>Ø¥Ø¬Ù…Ø§Ù„ÙŠ VIP</h5><p id="monthTotalVIP">0</p></div>
            </div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Ø§Ù„ÙŠÙˆÙ…</th><th>Ø§Ù„Ø³Ø¬Ù„</th><th>Ø§Ù„Ù…Ø³ØªÙ‡Ù„Ùƒ</th><th>Ø§Ù„Ø£ÙƒØ³Ø¯Ø©</th></tr></thead>
                    <tbody id="sessionsReportBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Ù‚Ø³Ù… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (Ù…Ø¹ Ø¥Ø¶Ø§ÙØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù‚Ø³Ù…) -->
        <div id="tab-users" class="hidden">
            <div style="background:#f9f9f9; padding:20px; border-radius:15px; margin-bottom: 20px;">
                <h4 id="formTitle">ğŸ“ Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <input type="text" id="newRealName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ">
                    <input type="text" id="newUsername" placeholder="Ø§Ø³Ù… Ø§Ù„Ø¯Ø®ÙˆÙ„">
                    <input type="text" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
                    <select id="newDepartment">
                        <option value="requests">Ù‚Ø³Ù… Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                        <option value="whatsapp">Ù‚Ø³Ù… Ø§Ù„ÙˆØ§ØªØ³</option>
                        <option value="receivers">Ù‚Ø³Ù… Ù…ØªÙ„Ù‚ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</option>
                    </select>
                </div>
                <button onclick="saveUser()" id="saveUserBtn" class="btn btn-success" style="width:100%; margin-top:10px;">Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¸Ù</button>
            </div>
            <div class="table-responsive">
                <table>
                    <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ù‚Ø³Ù…</th><th>Username</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="usersManagementBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…ÙˆØ¸Ù -->
    <div id="employeeSection" class="hidden">
        <h4 id="welcomeMsg"></h4>
        <div style="text-align: center;">
            <div style="background: #f1f2f6; padding: 20px; border-radius: 20px;">
                <div id="timerLabel" class="timer-label">Ø±ØµÙŠØ¯ Ø§Ù„Ø¨Ø±ÙŠÙƒ Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ</div>
                <div class="timer-display" id="userTimer">00:00</div>
                <h3 id="userStatusMsg"></h3>
                <div id="overtimeAlert" class="hidden" style="color:red; font-weight:bold;">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø£ÙƒØ³Ø¯Ø©!</div>
            </div>

            <div id="breakLimitAlert" style="background:#fff3cd; padding:15px; border-radius:10px; margin-top:15px; display:none; color:#856404;">
            </div>

            <div id="controlsArea" style="margin-top: 15px;">
                <input type="text" id="breakReason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø¨Ø±ÙŠÙƒ..." style="text-align: center;">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <button onclick="startMyBreak('Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…')" class="btn btn-success">ğŸ” Ø¨Ø¯Ø¡ Ø¨Ø±ÙŠÙƒ</button>
                    <button onclick="startMyBreak('ØµÙ„Ø§Ø©')" class="btn btn-info">ğŸ•Œ ØµÙ„Ø§Ø©</button>
                </div>
            </div>
            <div id="stopArea" class="hidden" style="margin-top:20px;">
                <button onclick="stopMyBreak()" class="btn btn-danger" style="width: 100%; padding: 20px; font-size: 1.5rem;">ğŸ›‘ Ø¥Ù†Ù‡Ø§Ø¡</button>
            </div>
        </div>
    </div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyC2J8fVx7qAz_g33gUNQxXMEJHsWeFrjuk",
        authDomain: "break-3ccd9.firebaseapp.com",
        projectId: "break-3ccd9",
        storageBucket: "break-3ccd9.firebasestorage.app",
        messagingSenderId: "785237776836",
        appId: "1:785237776836:web:0a0062bf07359391fd6c91",
        databaseURL: "https://break-3ccd9-default-rtdb.firebaseio.com/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let allUsersData = {}, currentUser = null, timerInterval = null, soundActive = false;
    let deptLimits = { requests: 2, whatsapp: 2, receivers: 2 };
    const MANAGERS = ['mahmoud', 'abutamim', 'ahmed', 'admin'];

    // Ù…Ø²Ø§Ù…Ù†Ø© ÙˆÙ‚Øª Ø§Ù„Ø³ÙŠØ±ÙØ±
    let serverOffset = 0;
    db.ref(".info/serverTimeOffset").on("value", s => serverOffset = s.val() || 0);
    function getServerTime() { return Date.now() + serverOffset; }

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª (Ø§Ù„Ø­Ø¯ÙˆØ¯)
    db.ref('settings/deptLimits').on('value', snap => {
        if(snap.val()) {
            deptLimits = snap.val();
            document.getElementById('limit_requests').value = deptLimits.requests;
            document.getElementById('limit_whatsapp').value = deptLimits.whatsapp;
            document.getElementById('limit_receivers').value = deptLimits.receivers;
        }
    });

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
    db.ref('users').on('value', (snap) => {
        allUsersData = snap.val() || {};
        document.getElementById('loading').style.display = 'none';
        document.getElementById('mainContainer').classList.remove('hidden');
        
        if (currentUser) {
            currentUser = allUsersData[currentUser.username] || currentUser;
            if (currentUser.role === 'admin') { 
                renderMonitorTable(); 
                renderUserManagementTable();
            } else { 
                updateUserUI(); 
                checkDeptLimit();
            }
        }
    });

    function checkDeptLimit() {
        if(!currentUser || currentUser.role === 'admin') return;
        const myDept = currentUser.department || 'requests';
        const activeInDept = Object.values(allUsersData).filter(u => u.isOnBreak && u.department === myDept && u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…').length;
        const limit = deptLimits[myDept] || 2;
        
        const box = document.getElementById('breakLimitAlert');
        if(activeInDept >= limit && !currentUser.isOnBreak) {
            box.style.display = 'block';
            box.innerText = `âš ï¸ ØªÙ†Ø¨ÙŠÙ‡: ÙˆØµÙ„ Ù‚Ø³Ù…Ùƒ (${getDeptName(myDept)}) Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¨Ø±ÙŠÙƒ (${limit}). Ø§Ù†ØªØ¸Ø± Ø²Ù…Ù„Ø§Ø¡Ùƒ.`;
        } else {
            box.style.display = 'none';
        }
    }

    function attemptLogin() {
        const u = document.getElementById('loginUser').value.trim().toLowerCase();
        const p = document.getElementById('loginPass').value.trim();
        if (allUsersData[u] && allUsersData[u].password === p) {
            currentUser = allUsersData[u];
            currentUser.role = MANAGERS.includes(u) ? 'admin' : 'employee';
            if (currentUser.role === 'admin') showAdmin(); else showEmployee();
            startGlobalTimer();
        } else alert('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª');
    }

    function saveUser() {
        const un = document.getElementById('newUsername').value.trim().toLowerCase();
        const name = document.getElementById('newRealName').value;
        const pass = document.getElementById('newPassword').value;
        const dept = document.getElementById('newDepartment').value;
        if(!un || !pass) return alert("Ø£ÙƒÙ…Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
        
        db.ref('users/' + un).update({
            username: un, realName: name, password: pass, department: dept,
            usedSeconds: 0, isOnBreak: false, allowance: 45
        }).then(() => alert("ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© âœ…"));
    }

    function updateLimits() {
        const newLimits = {
            requests: parseInt(document.getElementById('limit_requests').value),
            whatsapp: parseInt(document.getElementById('limit_whatsapp').value),
            receivers: parseInt(document.getElementById('limit_receivers').value)
        };
        db.ref('settings/deptLimits').set(newLimits).then(() => alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø­Ø¯ÙˆØ¯ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… âœ…"));
    }

    function startMyBreak(type) {
        if(currentUser.isOnBreak) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø¯ Ø§Ù„Ù‚Ø³Ù…
        if (type === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…') {
            const myDept = currentUser.department || 'requests';
            const activeInDept = Object.values(allUsersData).filter(u => u.isOnBreak && u.department === myDept && u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…').length;
            if (activeInDept >= (deptLimits[myDept] || 2)) {
                return alert("Ø¹Ø°Ø±Ø§Ù‹ØŒ ÙˆØµÙ„ Ù‚Ø³Ù…Ùƒ Ù„Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ø§Ù„Ù…Ø³Ù…ÙˆØ­ Ø¨Ù‡ Ø­Ø§Ù„ÙŠØ§Ù‹.");
            }
        }

        db.ref('users/' + currentUser.username).update({
            isOnBreak: true, breakType: type, lastStartTime: getServerTime(), lastReason: document.getElementById('breakReason').value || type
        });
    }

    function stopMyBreak() {
        const u = currentUser;
        const duration = Math.floor((getServerTime() - u.lastStartTime) / 1000);
        const updates = { isOnBreak: false };
        if(u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…') updates.usedSeconds = (u.usedSeconds || 0) + duration;
        
        db.ref('users/' + u.username + '/sessions').push({
            date: new Date().toLocaleDateString('ar-EG'),
            type: u.breakType, duration: duration, reason: u.lastReason || ''
        });
        db.ref('users/' + u.username).update(updates);
    }

    function renderMonitorTable() {
        const tbody = document.getElementById('monitorBody');
        tbody.innerHTML = '';
        let counts = { requests: 0, whatsapp: 0, receivers: 0 };

        Object.values(allUsersData).forEach(u => {
            if (MANAGERS.includes(u.username)) return;
            if (u.isOnBreak && u.breakType === 'Ø¨Ø±ÙŠÙƒ Ø¹Ø§Ù…') counts[u.department || 'requests']++;

            const status = u.isOnBreak ? `<b style="color:red;">${u.breakType}</b>` : '<b style="color:green;">Ù…ØªØ§Ø­</b>';
            tbody.innerHTML += `
                <tr>
                    <td>${u.realName} <span class="dept-tag">${getDeptName(u.department)}</span></td>
                    <td>${status}</td>
                    <td>${u.usedSeconds || 0} Ø«Ø§Ù†ÙŠØ©</td>
                    <td>${u.prayerSeconds || 0}</td>
                    <td><button onclick="adminStop('${u.username}')" class="btn btn-danger btn-sm">Ø¥ÙŠÙ‚Ø§Ù Ø¥Ø¬Ø¨Ø§Ø±ÙŠ</button></td>
                </tr>`;
        });

        document.getElementById('statusCountersDisplay').innerHTML = `
            Ø·Ù„Ø¨Ø§Øª: (${counts.requests}/${deptLimits.requests}) | 
            ÙˆØ§ØªØ³: (${counts.whatsapp}/${deptLimits.whatsapp}) | 
            Ù…ØªÙ„Ù‚ÙŠ: (${counts.receivers}/${deptLimits.receivers})
        `;
    }

    function renderUserManagementTable() {
        const tb = document.getElementById('usersManagementBody');
        tb.innerHTML = '';
        Object.values(allUsersData).forEach(u => {
            if(MANAGERS.includes(u.username)) return;
            tb.innerHTML += `<tr><td>${u.realName}</td><td>${getDeptName(u.department)}</td><td>${u.username}</td><td><button onclick="deleteUser('${u.username}')" class="btn btn-danger btn-sm">Ø­Ø°Ù</button></td></tr>`;
        });
    }

    function getDeptName(code) {
        const names = { requests: "Ø·Ù„Ø¨Ø§Øª", whatsapp: "ÙˆØ§ØªØ³", receivers: "Ù…ØªÙ„Ù‚ÙŠ Ø·Ù„Ø¨Ø§Øª" };
        return names[code] || "Ø¹Ø§Ù…";
    }

    function adminStop(un) {
        db.ref('users/' + un).update({ isOnBreak: false });
    }

    function deleteUser(un) {
        if(confirm("Ø­Ø°ÙØŸ")) db.ref('users/' + un).remove();
    }

    function showAdmin() { 
        document.getElementById('loginSection').classList.add('hidden'); 
        document.getElementById('adminSection').classList.remove('hidden'); 
    }
    function showEmployee() { 
        document.getElementById('loginSection').classList.add('hidden'); 
        document.getElementById('employeeSection').classList.remove('hidden'); 
        document.getElementById('welcomeMsg').innerText = `Ø£Ù‡Ù„Ø§Ù‹ ${currentUser.realName} - Ù‚Ø³Ù… ${getDeptName(currentUser.department)}`;
    }
    function switchAdminTab(t) {
        ['tab-monitor','tab-reports','tab-users'].forEach(id => document.getElementById(id).classList.add('hidden'));
        document.getElementById('tab-'+t).classList.remove('hidden');
    }
    function startGlobalTimer() { 
        setInterval(() => { if(currentUser) updateUserUI(); if(currentUser?.role === 'admin') renderMonitorTable(); }, 1000); 
    }
    function updateUserUI() {
        if(!currentUser || currentUser.role === 'admin') return;
        const timer = document.getElementById('userTimer');
        if(currentUser.isOnBreak) {
            const elapsed = Math.floor((getServerTime() - currentUser.lastStartTime)/1000);
            timer.innerText = elapsed + " Ø«Ø§Ù†ÙŠØ©";
            document.getElementById('stopArea').classList.remove('hidden');
            document.getElementById('controlsArea').classList.add('hidden');
        } else {
            timer.innerText = "00:00";
            document.getElementById('stopArea').classList.add('hidden');
            document.getElementById('controlsArea').classList.remove('hidden');
        }
    }
    function logout() { location.reload(); }
    function enableSound() { soundActive = true; alert("ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ØµÙˆØª"); }
</script>
</body>
</html>
