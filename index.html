<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Break 2 System | 3D V7.0</title>
    <!-- Ø®Ø· Cairo -->
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@300;500;700;900&display=swap" rel="stylesheet">
    <!-- Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª FontAwesome Ù„Ù„ØªØ¬Ù…ÙŠÙ„ -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root {
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            --primary: #6366f1;
            --accent: #a855f7;
            --text-light: #ffffff;
            --text-dim: #cbd5e1;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Cairo', sans-serif;
            margin: 0;
            background: #0f172a;
            color: var(--text-light);
            min-height: 100vh;
            overflow-x: hidden;
            /* Ø®Ù„ÙÙŠØ© Ù…ØªØ­Ø±ÙƒØ© 3D */
            background: linear-gradient(-45deg, #0f172a, #1e1b4b, #312e81, #0f172a);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
        }

        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ØªØ£Ø«ÙŠØ± Ø¹Ø§Ø¦Ù… Ø®Ù„ÙÙŠ */
        .orb {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            z-index: -1;
            animation: floatOrb 10s infinite alternate;
        }
        .orb-1 { top: 10%; left: 10%; width: 300px; height: 300px; background: var(--primary); opacity: 0.4; }
        .orb-2 { bottom: 10%; right: 10%; width: 250px; height: 250px; background: var(--accent); opacity: 0.4; animation-delay: -5s; }

        @keyframes floatOrb { from { transform: translate(0, 0); } to { transform: translate(30px, 50px); } }

        .container { max-width: 1400px; margin: 0 auto; padding: 20px; position: relative; z-index: 1; }

        /* --- ØªØµÙ…ÙŠÙ… Ø§Ù„Ø²Ø¬Ø§Ø¬ 3D --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            border-top: 1px solid rgba(255,255,255,0.4);
            border-left: 1px solid rgba(255,255,255,0.4);
            box-shadow: var(--glass-shadow);
            border-radius: 24px;
            padding: 30px;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        /* Ø­Ø±ÙƒØ© Ø§Ù„Ù€ 3D Ø¹Ù†Ø¯ Ø§Ù„ØªØ­ÙˆÙŠÙ… */
        .tilt-effect {
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .tilt-effect:hover {
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 15px 40px rgba(0,0,0,0.5);
            border-color: rgba(255,255,255,0.5);
        }

        /* --- Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ --- */
        #login-page {
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .login-card {
            width: 100%;
            max-width: 420px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }
        .login-card::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
            transform: rotate(45deg);
            animation: shine 3s infinite;
        }
        @keyframes shine { 0% { left: -100%; top: -100%; } 100% { left: 100%; top: 100%; } }

        h2 { margin: 0; font-weight: 900; letter-spacing: 1px; background: linear-gradient(to right, #fff, #a5b4fc); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        
        /* Inputs & Buttons */
        label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-dim); text-align: right; }
        input, select, textarea {
            width: 100%; padding: 14px 20px; 
            background: rgba(15, 23, 42, 0.6);
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white; font-family: 'Cairo'; font-size: 1rem;
            transition: 0.3s;
        }
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            background: rgba(15, 23, 42, 0.8);
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3);
        }

        .btn-3d {
            width: 100%; background: linear-gradient(135deg, var(--primary), var(--accent));
            border: none; padding: 15px; border-radius: 12px;
            color: white; font-weight: bold; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 15px rgba(99, 102, 241, 0.4);
            transition: 0.3s; position: relative; top: 0;
            overflow: hidden;
        }
        .btn-3d:hover { box-shadow: 0 6px 20px rgba(99, 102, 241, 0.6); transform: translateY(-2px); }
        .btn-3d:active { top: 2px; box-shadow: 0 2px 10px rgba(99, 102, 241, 0.4); }

        /* --- Navbar --- */
        .nav-bar {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px 30px; margin-bottom: 30px;
            background: rgba(30, 41, 59, 0.7);
        }
        .role-badge { background: linear-gradient(90deg, #f59e0b, #d97706); padding: 4px 12px; border-radius: 20px; font-size: 0.8rem; color: #fff; box-shadow: 0 2px 10px rgba(245, 158, 11, 0.3); }

        .nav-btn {
            background: transparent; border: none; padding: 10px 20px;
            color: var(--text-dim); font-family: 'Cairo'; font-weight: 700; cursor: pointer;
            border-radius: 12px; transition: 0.3s;
        }
        .nav-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .nav-btn.active { background: var(--primary); color: white; box-shadow: 0 0 15px rgba(99, 102, 241, 0.4); }
        .btn-danger-glow { color: #fca5a5; }
        .btn-danger-glow:hover { background: rgba(239, 68, 68, 0.2); color: #ef4444; }

        /* --- Layout --- */
        .main-grid { display: grid; grid-template-columns: 380px 1fr; gap: 30px; }
        @media (max-width: 950px) { .main-grid { grid-template-columns: 1fr; } }

        h3 { display: flex; align-items: center; gap: 10px; color: var(--text-light); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; margin-top: 0; }

        /* --- Feed Cards (3D Items) --- */
        .feed-card {
            background: rgba(30, 41, 59, 0.6);
            border-radius: 16px; padding: 20px; margin-bottom: 20px;
            border: 1px solid rgba(255,255,255,0.05);
            position: relative; overflow: hidden;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        .feed-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; background: var(--warning); box-shadow: 0 0 10px var(--warning); }
        .feed-card.done::before { background: var(--success); box-shadow: 0 0 10px var(--success); }
        .feed-card.price::before { background: var(--primary); box-shadow: 0 0 10px var(--primary); }
        
        /* 3D Hover Logic (JS will enhance this) */
        .feed-card:hover { transform: translateY(-5px) scale(1.02); background: rgba(30, 41, 59, 0.8); z-index: 10; border-color: rgba(255,255,255,0.2); box-shadow: 0 20px 40px rgba(0,0,0,0.4); }

        .card-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .branch-title { font-size: 1.2rem; font-weight: 700; color: white; }
        .meta-tag { background: rgba(255,255,255,0.1); padding: 4px 10px; border-radius: 8px; font-size: 0.85rem; color: #94a3b8; }
        
        .msg-bubble { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-right: 3px solid rgba(255,255,255,0.2); font-size: 1rem; line-height: 1.6; }

        /* Buttons Small */
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        .btn-s { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-weight: 700; font-family: 'Cairo'; color: white; transition: 0.2s; position: relative; overflow: hidden; }
        .btn-ok { background: linear-gradient(45deg, #059669, #10b981); }
        .btn-info { background: linear-gradient(45deg, #2563eb, #3b82f6); }
        
        /* Table Styles */
        .table-wrapper { overflow-x: auto; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: rgba(0,0,0,0.3); padding: 15px; text-align: right; color: #94a3b8; }
        td { padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        tr:hover td { background: rgba(255,255,255,0.02); }
        .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 700; background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid rgba(16, 185, 129, 0.3); }

        .hidden { display: none !important; }
        .fade-in { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* ØªØ®ØµÙŠØµ Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

    </style>
</head>
<body>

    <!-- Ø®Ù„ÙÙŠØ© Ù…Ø¶ÙŠØ¦Ø© -->
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    
    <audio id="notifSound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

    <div class="container">
        
        <!-- ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
        <div id="login-page">
            <div class="glass-panel login-card tilt-effect">
                <div style="font-size: 50px; margin-bottom: 10px; text-shadow: 0 0 20px rgba(99,102,241,0.5);">ğŸ›¡ï¸</div>
                <h2 style="margin-bottom: 5px;">BREAK 2 SYSTEM</h2>
                <p style="color:var(--text-dim); margin-bottom:30px; letter-spacing: 2px; font-size: 0.8rem;">SECURE V7.0 ACCESS</p>
                
                <div style="text-align: right;">
                    <label><i class="fas fa-user"></i> Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                    <input type="text" id="username" placeholder="Username">
                    
                    <label style="margin-top:15px;"><i class="fas fa-lock"></i> ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                    <input type="password" id="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>

                <button class="btn-3d" style="margin-top: 25px;" onclick="login()">
                    ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ <i class="fas fa-arrow-left" style="margin-right:8px;"></i>
                </button>
            </div>
        </div>

        <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù†Ø¸Ø§Ù… -->
        <div id="system-content" class="hidden fade-in">
            <!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
            <nav class="glass-panel nav-bar">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--primary), var(--accent)); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 0 15px var(--primary);">
                        <i class="fas fa-user-astronaut"></i>
                    </div>
                    <div>
                        <div id="userInfo" style="font-weight: 700; font-size: 1.1rem;">--</div>
                        <span class="role-badge" id="roleLabel">--</span>
                    </div>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button id="btnMain" class="nav-btn active" onclick="showPage('main')"><i class="fas fa-bolt"></i> Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</button>
                    <button id="btnArchive" class="nav-btn" onclick="showPage('archive')"><i class="fas fa-database"></i> Ø§Ù„Ø£Ø±Ø´ÙŠÙ</button>
                    <button class="nav-btn btn-danger-glow" onclick="logout()"><i class="fas fa-power-off"></i></button>
                </div>
            </nav>

            <!-- Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
            <div id="page-main">
                <div class="main-grid">
                    <!-- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© -->
                    <aside id="sideAction" class="fade-in"></aside>

                    <!-- Feed -->
                    <main>
                        <h3><i class="fas fa-satellite-dish" style="color:var(--success);"></i> Ø§Ù„Ø¨Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± Ù„Ù„Ø¹Ù…Ù„ÙŠØ§Øª</h3>
                        <div id="priceSection"></div>
                        <div id="activeList"></div>
                    </main>
                </div>
            </div>

            <!-- ØµÙØ­Ø© Ø§Ù„Ø£Ø±Ø´ÙŠÙ -->
            <div id="page-archive" class="hidden">
                <div class="glass-panel" style="margin-bottom: 20px;">
                    <h3><i class="fas fa-search"></i> ØªØµÙÙŠØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3>
                    <div class="main-grid" style="grid-template-columns: 1fr 1fr 1fr; gap:15px;">
                        <div><input type="text" id="fOrder" oninput="filterHistory()" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±..."></div>
                        <div id="branchFilterBox">
                            <select id="fBranch" onchange="filterHistory()">
                                <option value="">Ø§Ù„ÙƒÙ„</option>
                                <option>Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§</option>
                                <option>Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡</option>
                                <option>ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³</option>
                                <option>Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯</option>
                                <option>Ø§Ù„Ù…Ø¹Ù‡Ø¯</option>
                                <option>Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡</option>
                            </select>
                        </div>
                        <div><input type="text" id="fDriver" oninput="filterHistory()" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±..."></div>
                    </div>
                </div>

                <div class="glass-panel table-wrapper">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙˆÙ‚Øª</th>
                                <th>Ø§Ù„ÙØ±Ø¹</th>
                                <th>Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</th>
                                <th>Ø§Ù„Ø·ÙŠØ§Ø±</th>
                                <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                                <th>Ø§Ù„Ù…Ø±Ø³Ù„</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="archiveTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-database-compat.js"></script>

    <script>
        // -----------------------------------------
        // 1. WhatsApp Config
        // -----------------------------------------
        const WA_GATEWAY = { instance_id: 'instance157671', token: 'cpx85mx613v868fe' };
        
        // 2. Managers Contacts
        const branchManagers = {
            "Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§": "01271301772", "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡": "201022222222",
            "ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³": "201033333333", "Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯": "201044444444",
            "Ø§Ù„Ù…Ø¹Ù‡Ø¯": "201055555555", "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡": "201066666666"
        };

        // 3. Firebase Config
        const firebaseConfig = {
            apiKey: "AIzaSyBSwsheoAEJm3pLMI8lhVvzFnLS-a4FrVA",
            authDomain: "break2-5de32.firebaseapp.com",
            databaseURL: "https://break2-5de32-default-rtdb.firebaseio.com",
            projectId: "break2-5de32",
            storageBucket: "break2-5de32.firebasestorage.app",
            messagingSenderId: "864134684796",
            appId: "1:864134684796:web:078af20f713c95a08be9f9"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Users Data
        const users = {
            "admin": { pass: "123", role: "admin", name: "Master Admin" },
            "ahmed": { pass: "123", role: "callcenter", name: "Ahmed Hamdy" },
            "mahmoud": { pass: "2002", role: "callcenter", name: "Mahmoud Hany" },
            "Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§": { pass: "123", role: "branch", name: "Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§" },
            "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡": { pass: "123", role: "branch", name: "Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡" },
            "ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³": { pass: "123", role: "branch", name: "ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³" },
            "Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯": { pass: "123", role: "branch", name: "Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯" },
            "Ø§Ù„Ù…Ø¹Ù‡Ø¯": { pass: "123", role: "branch", name: "Ø§Ù„Ù…Ø¹Ù‡Ø¯" },
            "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡": { pass: "123", role: "branch", name: "Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡" }
        };

        let currentUser = null;
        let allData = [];

        // WhatsApp Sender
        async function sendWhatsAppToManager(branchName, orderNum, driver, msg) {
            const targetPhone = branchManagers[branchName];
            if (!targetPhone) return;
            const messageBody = `ğŸš¨ *Ø¨Ù„Ø§Øº Ø¬Ø¯ÙŠØ¯ | Break 2 System*\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\nğŸ¢ *Ø§Ù„ÙØ±Ø¹:* ${branchName}\nğŸ“ *Ø§Ù„Ø£ÙˆØ±Ø¯Ø±:* ${orderNum}\nğŸ›µ *Ø§Ù„Ø·ÙŠØ§Ø±:* ${driver}\nâš ï¸ *Ø§Ù„Ø´ÙƒÙˆÙ‰:* ${msg}\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`;
            try {
                await fetch(`https://api.ultramsg.com/${WA_GATEWAY.instance_id}/messages/chat`, {
                    method: 'POST', headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ token: WA_GATEWAY.token, to: targetPhone, body: messageBody })
                });
            } catch (e) { console.error(e); }
        }

        // Auth Logic
        function login() {
            const u = document.getElementById('username').value.trim();
            const p = document.getElementById('password').value.trim();
            if (users[u] && users[u].pass === p) {
                localStorage.setItem('break2_user', JSON.stringify({ id: u, ...users[u] }));
                location.reload();
            } else alert("Access Denied âŒ");
        }
        function logout() { localStorage.removeItem('break2_user'); location.reload(); }

        window.onload = () => {
            const saved = localStorage.getItem('break2_user');
            if (saved) {
                currentUser = JSON.parse(saved);
                document.getElementById('login-page').classList.add('hidden');
                document.getElementById('system-content').classList.remove('hidden');
                document.getElementById('userInfo').innerText = currentUser.name;
                document.getElementById('roleLabel').innerText = currentUser.role.toUpperCase();
                setupSideBar();
                listenToData();
                setupTiltEffect(); // Activate 3D effects
            }
        };

        function setupSideBar() {
            const side = document.getElementById('sideAction');
            if (currentUser.role === 'admin' || currentUser.role === 'callcenter') {
                side.innerHTML = `
                    <div class="glass-panel tilt-effect">
                        <h3 style="color:var(--primary);"><i class="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ù„Ø§Øº</h3>
                        <label>Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ù‡Ø¯Ù</label>
                        <select id="admBranch">
                            <option value="" disabled selected>-- Select --</option>
                            <option>Ø¹Ø¨Ø¯Ù‡ Ø¨Ø§Ø´Ø§</option><option>Ù†Ø§Ø¯ÙŠ Ø§Ù„Ø³ÙƒÙ‡</option>
                            <option>ÙŠÙˆØ³Ù Ø¹Ø¨Ø§Ø³</option><option>Ø¹Ø¨Ø§Ø³ Ø§Ù„Ø¹Ù‚Ø§Ø¯</option>
                            <option>Ø§Ù„Ù…Ø¹Ù‡Ø¯</option><option>Ø§Ù„Ø¹Ø¨Ø§Ø³ÙŠÙ‡</option>
                        </select>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                        <input type="text" id="admOrder" placeholder="#">
                        <label>Ø§Ø³Ù… Ø§Ù„Ø·ÙŠØ§Ø±</label>
                        <input type="text" id="admDriver" placeholder="Name">
                        <label>Ø§Ù„Ù…Ø´ÙƒÙ„Ø©</label>
                        <textarea id="admComplaint" placeholder="Details..."></textarea>
                        <button class="btn-3d" style="margin-top:10px;" onclick="sendComplaint()">Ø¥Ø±Ø³Ø§Ù„ <i class="fas fa-paper-plane"></i></button>
                    </div>`;
            } else {
                document.getElementById('branchFilterBox').classList.add('hidden');
                side.innerHTML = `
                    <div class="glass-panel tilt-effect">
                        <h3 style="color:var(--primary);"><i class="fas fa-tags"></i> Ø·Ù„Ø¨ ØªØ³Ø¹ÙŠØ±</h3>
                        <label>Ø±Ù‚Ù… Ø§Ù„Ø£ÙˆØ±Ø¯Ø±</label>
                        <input type="text" id="brOrder" placeholder="#">
                        <label>Ø§Ù„Ø³Ø¹Ø± Ø§Ù„Ù…Ù‚ØªØ±Ø­</label>
                        <input type="number" id="brPrice" placeholder="EGP">
                        <button class="btn-3d" style="margin-top:10px;" onclick="sendPriceReq()">Ø·Ù„Ø¨ <i class="fas fa-hand-holding-usd"></i></button>
                    </div>`;
            }
        }

        function showPage(pageId) {
            document.getElementById('page-main').classList.add('hidden');
            document.getElementById('page-archive').classList.add('hidden');
            document.getElementById('btnMain').classList.remove('active');
            document.getElementById('btnArchive').classList.remove('active');
            document.getElementById('page-' + pageId).classList.remove('hidden');
            if(pageId === 'main') document.getElementById('btnMain').classList.add('active');
            else document.getElementById('btnArchive').classList.add('active');
        }

        function listenToData() {
            db.ref('system_v6').on('value', snap => {
                allData = [];
                snap.forEach(child => {
                    const item = child.val();
                    item.id = child.key;
                    if (item.type === 'price_request' && (Date.now() - item.timestamp > 1200000)) {
                        db.ref('system_v6/' + item.id).remove(); return;
                    }
                    allData.push(item);
                });
                renderUI();
                // Play sound if new item (simple check)
                // document.getElementById('notifSound').play().catch(()=>{}); 
            });
        }

        function renderUI() {
            const priceDiv = document.getElementById('priceSection');
            const activeDiv = document.getElementById('activeList');
            priceDiv.innerHTML = ""; activeDiv.innerHTML = "";

            allData.forEach(item => {
                if (currentUser.role === 'branch' && item.branch !== currentUser.name) return;

                if (item.type === 'price_request' && item.status === 'pending') {
                    if (currentUser.role === 'branch') return; // Hide pending price req from branch itself if needed
                     priceDiv.innerHTML += `
                        <div class="feed-card price tilt-effect">
                            <div class="card-header">
                                <div class="branch-title">ğŸ’° ${item.branch}</div>
                                <span class="meta-tag">#${item.orderNum}</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; align-items:center;">
                                <span style="font-size:1.2rem; font-weight:bold; color:var(--primary);">${item.suggestedPrice} EGP</span>
                                ${(currentUser.role === 'admin' || currentUser.role === 'callcenter') ? `
                                    <div style="display:flex; gap:5px;">
                                        <input type="number" id="admP-${item.id}" value="${item.suggestedPrice}" style="width:70px; padding:5px; height:auto; margin:0;">
                                        <button class="btn-s btn-ok" onclick="approvePrice('${item.id}')">OK</button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>`;
                } else if (item.type === 'complaint' && item.status === 'pending') {
                    activeDiv.innerHTML += `
                        <div class="feed-card tilt-effect">
                            <div class="card-header">
                                <div class="branch-title"><i class="fas fa-map-marker-alt" style="color:#ef4444;"></i> ${item.branch}</div>
                                <span class="meta-tag"><i class="fas fa-user-edit"></i> ${item.senderName}</span>
                            </div>
                            <div style="margin-bottom:8px; font-size:0.9rem; color:#94a3b8;">
                                <span>ğŸ›µ ${item.driver}</span> | <span>ğŸ“¦ #${item.orderNum}</span>
                            </div>
                            <div class="msg-bubble">"${item.msg}"</div>
                            ${currentUser.role === 'branch' ? `
                                <div style="margin-top:15px; border-top:1px dashed rgba(255,255,255,0.2); padding-top:10px;">
                                    <div class="btn-row">
                                        <button class="btn-s btn-ok" onclick="replyComp('${item.id}', 'ØªÙ… Ø§Ù„Ø­Ù„ âœ…')">ØªÙ… Ø§Ù„Ø­Ù„ âœ…</button>
                                        <button class="btn-s btn-info" onclick="replyComp('${item.id}', 'ØªÙ…Øª Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ‘')">Ù…Ø±Ø§Ø¬Ø¹Ø© ğŸ‘</button>
                                    </div>
                                    <div style="display:flex; gap:5px; margin-top:8px;">
                                        <input type="text" id="reason-${item.id}" placeholder="Ø±Ø¯ ÙƒØªØ§Ø¨ÙŠ..." style="margin:0; background:rgba(0,0,0,0.2);">
                                        <button class="btn-s" style="background:#475569; width:auto; flex:none;" onclick="sendReason('${item.id}')"><i class="fas fa-reply"></i></button>
                                    </div>
                                </div>
                            ` : `<div style="text-align:center; padding:10px; margin-top:10px; background:rgba(255,255,255,0.05); border-radius:8px; font-size:0.8rem;">â³ Waiting for branch...</div>`}
                        </div>`;
                }
            });
            filterHistory();
            setupTiltEffect(); // Re-apply 3D logic to new elements
        }

        function filterHistory() {
            const body = document.getElementById('archiveTableBody');
            const fOrder = document.getElementById('fOrder').value.toLowerCase();
            const fBranch = currentUser.role === 'branch' ? currentUser.name : document.getElementById('fBranch').value;
            const fDriver = document.getElementById('fDriver').value.toLowerCase();

            body.innerHTML = "";
            const history = allData.filter(item => {
                if (item.type !== 'complaint' || item.status !== 'done') return false;
                if (fOrder && !item.orderNum.toString().includes(fOrder)) return false;
                if (fBranch && item.branch !== fBranch) return false;
                if (fDriver && !item.driver.toLowerCase().includes(fDriver)) return false;
                return true;
            });

            if(history.length === 0) {
                body.innerHTML = `<tr><td colspan="7" style="text-align:center; padding:20px;">No Data Found</td></tr>`;
                return;
            }

            history.reverse().forEach(item => {
                body.innerHTML += `<tr>
                    <td style="color:#94a3b8; font-size:0.8rem;">${item.time}</td>
                    <td>${item.branch}</td>
                    <td>#${item.orderNum}</td>
                    <td>${item.driver}</td>
                    <td><span class="status-badge">${item.reply}</span></td>
                    <td>${item.senderName}</td>
                    <td>${currentUser.role === 'admin' ? `<i class="fas fa-trash" style="color:var(--danger); cursor:pointer;" onclick="deleteItem('${item.id}')"></i>` : ''}</td>
                </tr>`;
            });
        }

        // Logic Actions
        function sendComplaint() {
            const b = document.getElementById('admBranch').value, o = document.getElementById('admOrder').value, d = document.getElementById('admDriver').value, m = document.getElementById('admComplaint').value;
            if(!b || !o || !m) return alert("Error: Missing Data");
            db.ref('system_v6').push({ type: 'complaint', branch: b, orderNum: o, driver: d, msg: m, status: 'pending', senderName: currentUser.name, time: new Date().toLocaleString('ar-EG') });
            sendWhatsAppToManager(b, o, d, m);
            document.getElementById('admOrder').value = ""; document.getElementById('admDriver').value = ""; document.getElementById('admComplaint').value = "";
        }
        function sendPriceReq() {
            const o = document.getElementById('brOrder').value, p = document.getElementById('brPrice').value;
            if(!o || !p) return;
            db.ref('system_v6').push({ type: 'price_request', branch: currentUser.name, orderNum: o, suggestedPrice: p, status: 'pending', timestamp: Date.now(), time: new Date().toLocaleString('ar-EG') });
            document.getElementById('brOrder').value=""; document.getElementById('brPrice').value="";
        }
        function approvePrice(id) {
            const p = document.getElementById('admP-'+id).value;
            db.ref('system_v6/'+id).update({ status: 'done', reply: "Price: "+p, approverName: currentUser.name });
        }
        function replyComp(id, msg) { db.ref('system_v6/'+id).update({ status: 'done', reply: msg }); }
        function sendReason(id) { const v = document.getElementById('reason-'+id).value; if(v) replyComp(id, v); }
        function deleteItem(id) { if(confirm("Delete?")) db.ref('system_v6/'+id).remove(); }

        // ------------------------------------------------
        // 4. Vanilla JS 3D Tilt Logic
        // ------------------------------------------------
        function setupTiltEffect() {
            const cards = document.querySelectorAll('.tilt-effect');
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left; // x pos within element
                    const y = e.clientY - rect.top;  // y pos within element
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = ((y - centerY) / centerY) * -10; // Max rotation deg
                    const rotateY = ((x - centerX) / centerX) * 10;

                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0) rotateY(0) scale(1)`;
                });
            });
        }
    </script>
</body>
</html>
